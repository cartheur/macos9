// *******************************************************************************************// DateTimeNumbers.c                                                       CLASSIC EVENT MODEL// *******************************************************************************************//// This program, which opens a single modeless dialog, demonstrates the formatting and display// of dates, times and numbers.//// The program utilises the following resources://// ╔	A 'plst' resource.//// ╔	An 'MBAR' resource, and 'MENU' resources for Apple/Application, File, and Edit menus //		(preload, non-purgeable).//// ╔	A 'DLOG' resource and associated 'dlgx', 'DITL', 'dfnt', and 'CNTL' resources //		(purgeable).  //// ╔	'hdlg' and 'STR#' resources (purgeable) for balloon help and help tags. //// ╔	A 'SIZE' resource with the acceptSuspendResumeEvents, canBackground, //		doesActivateOnFGSwitch, and isHighLevelEventAware flags set.//// *******************************************************************************************// ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии includes#include <Carbon.h>#include <string.h>// иииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии defines#define rMenubar								128#define mAppleApplication				128#define  iAbout									1#define mFile										129#define  iQuit									12#define mEdit										130#define  iCut										3#define  iCopy									4#define  iPaste									5#define  iClear									6#define rDialog									128#define  iStaticTextTodaysDate	2#define  iStaticTextCurrentTime	4#define  iEditTextTitle					10#define  iEditTextQuantity			11#define  iEditTextValue					12#define  iEditTextDate					13#define  iButtonEnter						18#define  iButtonClear						19#define  iStaticTextTitle				26#define  iStaticTextQuantity		27#define  iStaticTextUnitValue		28#define  iStaticTextTotalValue	29#define  iStaticTextDate				30#define kReturn									0x0D#define kEnter									0x03#define kTab										0x09#define kLeftArrow							0x1C#define kRightArrow							0x1D#define kUpArrow								0x1E#define kDownArrow							0x1F#define kBackspace							0x08#define kDelete									0x7F#define topLeft(r)							(((Point *) &(r))[0])#define botRight(r)							(((Point *) &(r))[1])// ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии global variablesBoolean					gRunningOnX = false;DialogRef				gDialogRef;DateCacheRecord	gDateCacheRec;Boolean					gDone;RgnHandle				gCursorRegionHdl;Boolean					gInBackground;// иииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии function prototypesvoid										main								(void);void										doPreliminaries			(void);OSErr										quitAppEventHandler	(AppleEvent *,AppleEvent *,SInt32);void										eventLoop						(void);void										doIdle							(void);void										doEvents						(EventRecord *);void										doMenuChoice				(SInt32);void										doCopyPString				(Str255,Str255);void										doTodaysDate				(void);void										doAcceptNewRecord		(void);void										doUnitAndTotalValue	(Str255,Str255);void										doDate							(Str255);void										doAdjustCursor			(WindowRef);void										doClearAllFields		(void);ControlKeyFilterResult	numericFilter				(ControlRef,SInt16 *,SInt16 *,EventModifiers *);void										helpTags						(void);	// ************************************************************************************** mainvoid  main(void){	MenuBarHandle				menubarHdl;	SInt32							response;	MenuRef							menuRef;	Boolean							runningOnX = false;	ControlKeyFilterUPP	numericFilterUPP;	ControlRef					controlRef;	// ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии do preliminaries	doPreliminaries();	// иииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии set up menu bar and menus	menubarHdl = GetNewMBar(rMenubar);	if(menubarHdl == NULL)		ExitToShell();	SetMenuBar(menubarHdl);	DrawMenuBar();	Gestalt(gestaltMenuMgrAttr,&response);	if(response & gestaltMenuMgrAquaLayoutMask)	{		menuRef = GetMenuRef(mFile);		if(menuRef != NULL)		{			DeleteMenuItem(menuRef,iQuit);			DeleteMenuItem(menuRef,iQuit - 1);			DisableMenuItem(menuRef,0);		}		gRunningOnX = true;	}	// ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии open modeless dialog	if(!(gDialogRef = GetNewDialog(rDialog,NULL,(WindowRef) -1)))		ExitToShell();	// ииии create universal procedure pointers for key filter, attach to two edit text controls	numericFilterUPP = NewControlKeyFilterUPP((ControlKeyFilterProcPtr) numericFilter);	GetDialogItemAsControl(gDialogRef,iEditTextQuantity,&controlRef);	SetControlData(controlRef,kControlEntireControl,kControlEditTextKeyFilterTag,								 sizeof(numericFilterUPP),&numericFilterUPP);	GetDialogItemAsControl(gDialogRef,iEditTextValue,&controlRef);	SetControlData(controlRef,kControlEntireControl,kControlEditTextKeyFilterTag,								 sizeof(numericFilterUPP),&numericFilterUPP);	// ииииииииииииииииииииииииииииииииииииииии set help tags, get today's date, and show window	if(gRunningOnX)		helpTags();	doTodaysDate();	ShowWindow(GetDialogWindow(gDialogRef));	// иииииииииииииииииииииииииииииииииииииииииииииииииииииииии initialise date cache structure	InitDateCache(&gDateCacheRec);	// иииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии enter eventLoop	eventLoop();}// *************************************************************************** doPreliminariesvoid  doPreliminaries(void){	OSErr	osError;	MoreMasterPointers(64);	InitCursor();	FlushEvents(everyEvent,0);	osError = AEInstallEventHandler(kCoreEventClass,kAEQuitApplication,														NewAEEventHandlerUPP((AEEventHandlerProcPtr) quitAppEventHandler),														0L,false);	if(osError != noErr)		ExitToShell();}// **************************************************************************** doQuitAppEventOSErr  quitAppEventHandler(AppleEvent *appEvent,AppleEvent *reply,SInt32 handlerRefcon){	OSErr			osError;	DescType	returnedType;	Size			actualSize;	osError = AEGetAttributePtr(appEvent,keyMissedKeywordAttr,typeWildCard,&returnedType,NULL,0,															&actualSize);	if(osError == errAEDescNotFound)	{		gDone = true;		osError = noErr;	} 	else if(osError == noErr)		osError = errAEParamMissed;	return osError;}// ********************************************************************************* eventLoopvoid  eventLoop(void){	EventRecord	eventStructure;	Boolean			gotEvent;	UInt32			sleepTime;	gDone = false;	sleepTime = GetCaretTime();	gCursorRegionHdl = NewRgn();	while(!gDone)	{		gotEvent = WaitNextEvent(everyEvent,&eventStructure,sleepTime,gCursorRegionHdl);		if(gotEvent)			doEvents(&eventStructure);		else			doIdle();	}}// ************************************************************************************ doIdlevoid  doIdle(void){	UInt32				rawSeconds;	static UInt32	oldRawSeconds;	Str255				timeString;	ControlRef		controlRef;	if(!gRunningOnX)		IdleControls(GetDialogWindow(gDialogRef));	GetDateTime(&rawSeconds);	if(rawSeconds > oldRawSeconds) 	{		TimeString(rawSeconds,true,timeString,NULL);		GetDialogItemAsControl(gDialogRef,iStaticTextCurrentTime,&controlRef);		SetControlData(controlRef,kControlEntireControl,kControlStaticTextTextTag,timeString[0],									 &timeString[1]);		Draw1Control(controlRef);		oldRawSeconds = rawSeconds;	}}// *********************************************************************************** doEventvoid	doEvents(EventRecord *eventStrucPtr){	WindowPartCode	partCode;	WindowRef				windowRef;	DialogRef				dialogRef;	SInt16					itemHit;	SInt8						charCode;	ControlRef			controlRef;	UInt32					finalTicks;	switch(eventStrucPtr->what)	{		case kHighLevelEvent:			AEProcessAppleEvent(eventStrucPtr);			break;		case mouseDown:			partCode = FindWindow(eventStrucPtr->where,&windowRef);			switch(partCode)			{				case inMenuBar:					doMenuChoice(MenuSelect(eventStrucPtr->where));					break;				case inContent:					if(IsDialogEvent(eventStrucPtr))						if(DialogSelect(eventStrucPtr,&dialogRef,&itemHit))							if(itemHit == iButtonEnter)							{								doAcceptNewRecord();								doClearAllFields();							}							else if(itemHit == iButtonClear)								doClearAllFields();					doAdjustCursor(windowRef);					break;				case inDrag:					DragWindow(windowRef,eventStrucPtr->where,NULL);					doAdjustCursor(windowRef);					break;				case inGoAway:					if(TrackGoAway(windowRef,eventStrucPtr->where))						gDone = true;					break;			}			break;		case keyDown:			charCode = eventStrucPtr->message & charCodeMask;			if((charCode == kReturn) || (charCode == kEnter))			{				GetDialogItemAsControl(gDialogRef,iButtonEnter,&controlRef);				HiliteControl(controlRef,kControlButtonPart);				Delay(8,&finalTicks);				HiliteControl(controlRef,kControlEntireControl);				doAcceptNewRecord();				doClearAllFields();				return;			}			if((eventStrucPtr->modifiers & cmdKey) != 0)			{				if(charCode == 'X' || charCode == 'x' ||	charCode == 'C' || charCode == 'c' ||						charCode == 'V' || charCode == 'v')				{					HiliteMenu(mEdit);					DialogSelect(eventStrucPtr,&dialogRef,&itemHit);					Delay(4,&finalTicks);					HiliteMenu(0);				}				else				{					doMenuChoice(MenuEvent(eventStrucPtr));				}				return;			}			DialogSelect(eventStrucPtr,&dialogRef,&itemHit);			if(charCode == kTab)				doAdjustCursor(GetDialogWindow(gDialogRef));			break;		case autoKey:			if((eventStrucPtr->modifiers & cmdKey) == 0)				DialogSelect(eventStrucPtr,&dialogRef,&itemHit);			break;		case updateEvt:		case activateEvt:			DialogSelect(eventStrucPtr,&dialogRef,&itemHit);			break;		case osEvt:			switch((eventStrucPtr->message >> 24) & 0x000000FF)			{				case suspendResumeMessage:					gInBackground = (eventStrucPtr->message & resumeFlag) == 0;					if(!gInBackground)						SetThemeCursor(kThemeArrowCursor);					break;									case mouseMovedMessage:					doAdjustCursor(GetDialogWindow(gDialogRef));					break;			}			break;	}}// ****************************************************************************** doMenuChoicevoid  doMenuChoice(SInt32 menuChoice){	MenuID				menuID;	MenuItemIndex	menuItem;	menuID	 = HiWord(menuChoice);	menuItem = LoWord(menuChoice);	if(menuID == 0)		return;	switch(menuID)	{		case mAppleApplication:			if(menuItem == iAbout)				SysBeep(10);			break;		case mFile:			if(menuItem == iQuit)				gDone = true;			break;		case mEdit:			switch(menuItem)			{				case iCut:					DialogCut(gDialogRef);					break;				case iCopy:					DialogCopy(gDialogRef);					break;				case iPaste:					DialogPaste(gDialogRef);					break;				case iClear:					DialogDelete(gDialogRef);					break;			}			break;	}	HiliteMenu(0);}// ***************************************************************************** doCopyPStringvoid  doCopyPString(Str255 sourceString,Str255 destinationString){	SInt16	stringLength;	stringLength = sourceString[0];	BlockMove(sourceString + 1,destinationString + 1,stringLength);	destinationString[0] = stringLength;}// ****************************************************************************** doTodaysDatevoid  doTodaysDate(void){	UInt32			rawSeconds;	Str255			dateString;	ControlRef	controlRef;	GetDateTime(&rawSeconds);	DateString(rawSeconds,longDate,dateString,NULL);	GetDialogItemAsControl(gDialogRef,iStaticTextTodaysDate,&controlRef);	SetControlData(controlRef,kControlEntireControl,kControlStaticTextTextTag,dateString[0],								 &dateString[1]);}// ************************************************************************* doAcceptNewRecordvoid  doAcceptNewRecord(void){	SInt16			theType;	Handle			theHandle;	Rect				theRect;	Str255			titleString, quantityString, valueString, dateString;	ControlRef	controlRef;	GetDialogItem(gDialogRef,iEditTextTitle,&theType,&theHandle,&theRect);	GetDialogItemText(theHandle,titleString);	GetDialogItem(gDialogRef,iEditTextQuantity,&theType,&theHandle,&theRect);	GetDialogItemText(theHandle,quantityString);	GetDialogItem(gDialogRef,iEditTextValue,&theType,&theHandle,&theRect);	GetDialogItemText(theHandle,valueString);	GetDialogItem(gDialogRef,iEditTextDate,&theType,&theHandle,&theRect);	GetDialogItemText(theHandle,dateString);		if(titleString[0] == 0 || quantityString[0] == 0 || valueString[0] == 0 || 		 dateString[0] == 0)	{		SysBeep(10);		return;	}	GetDialogItemAsControl(gDialogRef,iStaticTextTitle,&controlRef);	SetControlData(controlRef,kControlEntireControl,kControlStaticTextTextTag,titleString[0],								 &titleString[1]);	Draw1Control(controlRef);	GetDialogItemAsControl(gDialogRef,iStaticTextQuantity,&controlRef);	SetControlData(controlRef,kControlEntireControl,kControlStaticTextTextTag,quantityString[0],								 &quantityString[1]);	Draw1Control(controlRef);	doUnitAndTotalValue(valueString,quantityString);	doDate(dateString);}// *********************************************************************** doUnitAndTotalValuevoid  doUnitAndTotalValue(Str255 valueString, Str255 quantityString){	Handle						itl4ResourceHdl;	SInt32						numpartsOffset;	SInt32						numpartsLength;	NumberParts				*numpartsTablePtr;	Str255						formatString = "\p'$'###,###,###.00;'Valueless';'Valueless'";	NumFormatString		formatStringRec;	Str255						formattedNumString;	extended80				value80Bit;	SInt32						quantity;	double						valueDouble;	FormatResultType	result;	ControlRef				controlRef;	GetIntlResourceTable(smSystemScript,iuNumberPartsTable,&itl4ResourceHdl,&numpartsOffset,											 &numpartsLength);	numpartsTablePtr = (NumberPartsPtr) ((SInt32) *itl4ResourceHdl + numpartsOffset);	StringToFormatRec(formatString,numpartsTablePtr,&formatStringRec);	StringToExtended(valueString,&formatStringRec,numpartsTablePtr,&value80Bit);	ExtendedToString(&value80Bit,&formatStringRec,numpartsTablePtr,formattedNumString);	GetDialogItemAsControl(gDialogRef,iStaticTextUnitValue,&controlRef);	SetControlData(controlRef,kControlEntireControl,kControlStaticTextTextTag,								 formattedNumString[0],&formattedNumString[1]);	Draw1Control(controlRef);	StringToNum(quantityString,&quantity);	valueDouble = x80tod(&value80Bit);	valueDouble = valueDouble * quantity;	dtox80(&valueDouble,&value80Bit);	result = ExtendedToString(&value80Bit,&formatStringRec,numpartsTablePtr,														formattedNumString);	if(result == fFormatOverflow)		doCopyPString("\p(Too large to display)",formattedNumString);	GetDialogItemAsControl(gDialogRef,iStaticTextTotalValue,&controlRef);	SetControlData(controlRef,kControlEntireControl,kControlStaticTextTextTag,								 formattedNumString[0],&formattedNumString[1]);	Draw1Control(controlRef);}// ************************************************************************************ doDatevoid  doDate(Str255 dateString){	SInt32				lengthUsed;	LongDateRec		longDateTimeRec;	LongDateTime	longDateTimeValue;	ControlRef		controlRef;	longDateTimeRec.ld.hour = 0;	longDateTimeRec.ld.minute = 0;	longDateTimeRec.ld.second = 0;	StringToDate((Ptr) dateString + 1,dateString[0],&gDateCacheRec,&lengthUsed,							 &longDateTimeRec);	LongDateToSeconds(&longDateTimeRec,&longDateTimeValue);	LongDateString(&longDateTimeValue,longDate,dateString,NULL);	GetDialogItemAsControl(gDialogRef,iStaticTextDate,&controlRef);	SetControlData(controlRef,kControlEntireControl,kControlStaticTextTextTag,dateString[0],								 &dateString[1]);	Draw1Control(controlRef);}// **************************************************************************** doAdjustCursorvoid  doAdjustCursor(WindowRef windowRef){	GrafPtr		oldPort;	RgnHandle	arrowRegion,iBeamRegion;	SInt16		currentFocusItem;	SInt16		theType;	Handle		theHandle;	Rect			iBeamRect;	Point			mouseXY;	GetPort(&oldPort);	SetPortWindowPort(windowRef);	arrowRegion = NewRgn();	iBeamRegion = NewRgn();	SetRectRgn(arrowRegion,-32768,-32768,32767,32767);	currentFocusItem = GetDialogKeyboardFocusItem(gDialogRef);	GetDialogItem(gDialogRef,currentFocusItem,&theType,&theHandle,&iBeamRect);	LocalToGlobal(&topLeft(iBeamRect));	LocalToGlobal(&botRight(iBeamRect));		RectRgn(iBeamRegion,&iBeamRect);	DiffRgn(arrowRegion,iBeamRegion,arrowRegion);		GetMouse(&mouseXY);	LocalToGlobal(&mouseXY);	if(PtInRgn(mouseXY,iBeamRegion))	{		SetThemeCursor(kThemeIBeamCursor);		CopyRgn(iBeamRegion,gCursorRegionHdl);	}	else	{		SetThemeCursor(kThemeArrowCursor);		CopyRgn(arrowRegion,gCursorRegionHdl);	}	DisposeRgn(arrowRegion);	DisposeRgn(iBeamRegion);	SetPort(oldPort);}// ************************************************************************** doClearAllFieldsvoid  doClearAllFields(void){	SInt16			a;	ControlRef	controlRef;	Str255			theString = "\p";	for(a = iEditTextTitle;a <= iEditTextDate;a++)	{		GetDialogItemAsControl(gDialogRef,a,&controlRef);		SetControlData(controlRef,kControlEntireControl,kControlEditTextTextTag,theString[0],								 &theString[1]);		Draw1Control(controlRef);		if(a == iEditTextTitle)			SetKeyboardFocus(GetDialogWindow(gDialogRef),controlRef,kControlFocusNextPart);	}}// ***************************************************************************** numericFilterControlKeyFilterResult  numericFilter(ControlRef controlRef,SInt16* keyCode,SInt16 *charCode,																			EventModifiers *modifiers){	if(((char) *charCode >= '0') && ((char) *charCode <= '9') || (char) *charCode == '.' ||		 (BitTst(modifiers,15 - cmdKeyBit)))	{		return kControlKeyFilterPassKey;	}	switch(*charCode)	{		case kLeftArrow:		case kRightArrow:		case kUpArrow:		case kDownArrow:		case kBackspace:		case kDelete:			return kControlKeyFilterPassKey;			break;	}	SysBeep(10);	return kControlKeyFilterBlockKey;}// ********************************************************************************** helpTagsvoid  helpTags(void){	HMHelpContentRec	helpContent;	SInt16						a;	static SInt16			itemNumber[7] = { 1,3,21,22,23,24,25 };	ControlRef				controlRef;	memset(&helpContent,0,sizeof(helpContent));	HMSetTagDelay(5);	HMSetHelpTagsDisplayed(true);	helpContent.version = kMacHelpVersion;	helpContent.tagSide = kHMOutsideTopCenterAligned;	helpContent.content[kHMMinimumContentIndex].contentType = kHMStringResContent;	helpContent.content[kHMMinimumContentIndex].u.tagStringRes.hmmResID = 128;	for(a = 1;a <= 7; a++)	{		helpContent.content[kHMMinimumContentIndex].u.tagStringRes.hmmIndex = a;		GetDialogItemAsControl(gDialogRef,itemNumber[a - 1],&controlRef);		HMSetControlHelpContent(controlRef,&helpContent);	}}// *******************************************************************************************