// *******************************************************************************************// HelpDialog.c// *******************************************************************************************// ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии includes#include <Carbon.h>// иииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии defines#define rHelpModal						128#define  iUserPane						2#define  iScrollBar						3#define  iPopupMenu						4#define  eHelpDialog					9#define  eHelpDocRecord				10#define  eHelpText						11#define  eHelpPicture					12#define rTextIntroduction			128#define rTextCreatingText			129#define rTextModifyHelp				130#define rPictIntroductionBase	128#define rPictCreatingTextBase	129#define kTextInset						4// ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии typedefstypedef struct{	Rect			bounds;	PicHandle	pictureHdl;} pictInfoStructure;typedef struct{	TEHandle					textEditStrucHdl;	ControlRef				scrollbarHdl;	SInt16						pictCount;	pictInfoStructure	*pictInfoStructurePtr;}	docStructure, ** docStructureHandle;typedef struct{	RGBColor			backColour;	PixPatHandle	backPixelPattern;	Pattern				backBitPattern;} backColourPattern;// ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии global variablesModalFilterUPP					eventFilterUPP;ControlUserPaneDrawUPP	userPaneDrawFunctionUPP;ControlActionUPP				actionFunctionUPP;backColourPattern 			gBackColourPattern;SInt16									gTextResourceID;SInt16									gPictResourceBaseID;RgnHandle								gSavedClipRgn	= NULL;// иииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии function prototypesvoid						doHelp								(void);void						doCloseHelp						(DialogPtr,GrafPtr);void						doDisposeDescriptors	(void);pascal void  		userPaneDrawFunction	(ControlRef,SInt16);Boolean					doGetText							(DialogPtr,SInt16,Rect);Boolean					doGetPictureInfo			(DialogPtr,SInt16);pascal void			actionFunction				(ControlRef,SInt16);void						doScrollTextAndPicts	(DialogPtr);void 						doDrawPictures				(DialogPtr,Rect *);pascal Boolean	eventFilter						(DialogPtr,EventRecord *,SInt16 *);void						doSetBackgroundWhite	(void);extern void			doUpdate							(EventRecord *);extern void			doErrorAlert					(SInt16);// ************************************************************************************ doHelpvoid  doHelp(void){	DialogPtr						dialogPtr;	WindowRef						windowRef;	docStructureHandle	docStrucHdl;	GrafPtr							oldPort;	ControlRef					controlRef;	SInt16							itemHit, menuItem;	Rect								userPaneRect, destRect, viewRect;	// иииииииииииииииииииииииииииииииииииииииииииииииииииии create universal procedure pointers	eventFilterUPP					= NewModalFilterUPP(eventFilter);	userPaneDrawFunctionUPP	= NewControlUserPaneDrawUPP(userPaneDrawFunction);	actionFunctionUPP				= NewControlActionUPP(actionFunction);	// иииииииииииииииииииииииииииииииииииииииииииии create dialog and attach document structure	if(!(dialogPtr = GetNewDialog(rHelpModal,NULL,(WindowRef) -1)))	{		doErrorAlert(eHelpDialog);		doDisposeDescriptors();		return;	}	if(!(docStrucHdl = (docStructureHandle) NewHandle(sizeof(docStructure))))	{		doErrorAlert(eHelpDocRecord);		DisposeDialog(dialogPtr);		doDisposeDescriptors();		return;	}	windowRef = GetDialogWindow(dialogPtr);	SetWRefCon(windowRef,(SInt32) docStrucHdl);	// ииииииииииииииииииииииииииииииииииииииииииииииииииии set graphics port and default button		GetPort(&oldPort);	SetPortDialogPort(dialogPtr);	SetDialogDefaultItem(dialogPtr,kStdOkItemIndex);	// ииииииииииииииииииииииииииииииииииииииииииииииииииииииииии set user pane drawing function		GetDialogItemAsControl(dialogPtr,iUserPane,&controlRef);	SetControlData(controlRef,kControlEntireControl,kControlUserPaneDrawProcTag, 								 sizeof(userPaneDrawFunctionUPP),(Ptr) &userPaneDrawFunctionUPP);	// ииииииииииииииииииииииииииииии set destination and view rectangles, create edit structure	GetControlBounds(controlRef,&userPaneRect);	InsetRect(&userPaneRect,kTextInset,kTextInset / 2);	destRect = viewRect = userPaneRect;	(*docStrucHdl)->textEditStrucHdl = TEStyleNew(&destRect,&viewRect);	// ииииииииииииииииииииииии assign handle to scroll bar to relevant document structure field	GetDialogItemAsControl(dialogPtr,iScrollBar,&controlRef);	(*docStrucHdl)->scrollbarHdl = controlRef;	// ииииииииииииииииииии initialise picture information structure field of document structure	(*docStrucHdl)->pictInfoStructurePtr = NULL;	// ииииииииииииииииииииииииииии assign resource IDs of first topic's 'TEXT'/'styl' resources	gTextResourceID			= rTextIntroduction;	gPictResourceBaseID	= rPictIntroductionBase;	// ииииииииииииииииииииииииииииииииииииии load text resources and insert into edit structure	if(!(doGetText(dialogPtr,gTextResourceID,viewRect)))	{		doCloseHelp(dialogPtr,oldPort);		doDisposeDescriptors();		return;	}	// иииииииии search for option-space charas in text and load same number of 'PICT' resources	if(!(doGetPictureInfo(dialogPtr,gPictResourceBaseID)))	{		doCloseHelp(dialogPtr,oldPort);		doDisposeDescriptors();		return;	}	// иииииииииииииииииииииииииииииии create an empty region for saving the old clipping region	gSavedClipRgn = NewRgn();	// ииииииииииииииииииииииииииииииииииииии show window and save background colour and pattern	ShowWindow(GetDialogWindow(dialogPtr));	// ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии enter ModalDialog loop	do 	{		ModalDialog(eventFilterUPP,&itemHit);		if(itemHit == iPopupMenu)		{			SetControlValue((*docStrucHdl)->scrollbarHdl,0);			GetDialogItemAsControl(dialogPtr,iPopupMenu,&controlRef);			menuItem = GetControlValue(controlRef);			switch(menuItem)			{				case 1:					gTextResourceID 		= rTextIntroduction;					gPictResourceBaseID = rPictIntroductionBase;					break;				case 2:					gTextResourceID 		= rTextCreatingText;					gPictResourceBaseID = rPictCreatingTextBase;					break;				case 3:					gTextResourceID 		= rTextModifyHelp;					break;			}			if(!(doGetText(dialogPtr,gTextResourceID,viewRect)))			{				doCloseHelp(dialogPtr,oldPort);				doDisposeDescriptors();				return;			}			if(!(doGetPictureInfo(dialogPtr,gPictResourceBaseID)))			{				doCloseHelp(dialogPtr,oldPort);				doDisposeDescriptors();				return;			}			doDrawPictures(dialogPtr,&viewRect);		}				} while(itemHit != kStdOkItemIndex);	// ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии clean up			doCloseHelp(dialogPtr,oldPort);	doDisposeDescriptors();}// ******************************************************************************* doCloseHelpvoid  doCloseHelp(DialogPtr dialogPtr,GrafPtr oldPort){	docStructureHandle	docStrucHdl;	TEHandle						textEditStrucHdl;	SInt16							a;	docStrucHdl = (docStructureHandle) GetWRefCon(GetDialogWindow(dialogPtr));	textEditStrucHdl = (*docStrucHdl)->textEditStrucHdl;	if(gSavedClipRgn)		DisposeRgn(gSavedClipRgn);	if((*docStrucHdl)->textEditStrucHdl)		TEDispose((*docStrucHdl)->textEditStrucHdl);	if((*docStrucHdl)->pictInfoStructurePtr)	{		for(a=0;a<(*docStrucHdl)->pictCount;a++)			ReleaseResource((Handle) (*docStrucHdl)->pictInfoStructurePtr[a].pictureHdl);		DisposePtr((Ptr) (*docStrucHdl)->pictInfoStructurePtr);	}	DisposeHandle((Handle) docStrucHdl);	DisposeDialog(dialogPtr);	SetPort(oldPort);}// ********************************************************************** doDisposeDescriptorsvoid  doDisposeDescriptors(void){	DisposeModalFilterUPP(eventFilterUPP);	DisposeControlUserPaneDrawUPP(userPaneDrawFunctionUPP);	DisposeControlActionUPP(actionFunctionUPP);}// ********************************************************************** userPaneDrawFunctionpascal void  userPaneDrawFunction(ControlRef controlRef,SInt16 thePart){	Rect								itemRect, viewRect;	WindowRef						windowRef;	docStructureHandle	docStrucHdl;	TEHandle						textEditStrucHdl;	DialogPtr						dialogPtr;	Boolean 						inState;	windowRef = GetControlOwner(controlRef);	dialogPtr = GetDialogFromWindow(windowRef);	GetControlBounds(controlRef,&itemRect);	InsetRect(&itemRect,1,1);	itemRect.right += 15;	if(IsWindowVisible(windowRef))		inState = IsWindowHilited(windowRef);	DrawThemeListBoxFrame(&itemRect,inState);	doSetBackgroundWhite();	EraseRect(&itemRect);	docStrucHdl = (docStructureHandle) GetWRefCon(windowRef);	textEditStrucHdl = (*docStrucHdl)->textEditStrucHdl;	viewRect = (*textEditStrucHdl)->viewRect;	TEUpdate(&viewRect,textEditStrucHdl);	doDrawPictures(dialogPtr,&viewRect);}// ********************************************************************************* doGetTextBoolean  doGetText(DialogPtr dialogPtr,SInt16 textResourceID,Rect viewRect){	WindowRef						windowRef;	docStructureHandle	docStrucHdl;	TEHandle						textEditStrucHdl;	Handle							helpTextHdl;	StScrpHandle				stylScrpStrucHdl;	SInt16							numberOfLines, heightOfText, heightToScroll;	doSetBackgroundWhite();	windowRef = GetDialogWindow(dialogPtr);	docStrucHdl = (docStructureHandle) GetWRefCon(windowRef);	textEditStrucHdl = (*docStrucHdl)->textEditStrucHdl;	TESetSelect(0,32767,textEditStrucHdl);	TEDelete(textEditStrucHdl);	(*textEditStrucHdl)->destRect = (*textEditStrucHdl)->viewRect;	SetControlValue((*docStrucHdl)->scrollbarHdl,0);	helpTextHdl = GetResource('TEXT',textResourceID);	if(helpTextHdl == NULL)	{		doErrorAlert(eHelpText);		return false;	}	stylScrpStrucHdl = (StScrpHandle) GetResource('styl',textResourceID);	if(stylScrpStrucHdl == NULL)	{		doErrorAlert(eHelpText);		return false;	}	TEStyleInsert(*helpTextHdl,GetHandleSize(helpTextHdl),stylScrpStrucHdl,textEditStrucHdl);	ReleaseResource(helpTextHdl);	ReleaseResource((Handle) stylScrpStrucHdl);	numberOfLines = (*textEditStrucHdl)->nLines;	heightOfText = TEGetHeight((SInt32) numberOfLines,1,textEditStrucHdl);	if(heightOfText > (viewRect.bottom - viewRect.top))	{		heightToScroll = TEGetHeight((SInt32) numberOfLines,1,textEditStrucHdl) -																 (viewRect.bottom - viewRect.top);		SetControlMaximum((*docStrucHdl)->scrollbarHdl,heightToScroll);		ActivateControl((*docStrucHdl)->scrollbarHdl);		SetControlViewSize((*docStrucHdl)->scrollbarHdl,(*textEditStrucHdl)->viewRect.bottom - 										 	 (*textEditStrucHdl)->viewRect.top);	}	else	{		DeactivateControl((*docStrucHdl)->scrollbarHdl);	}	return true;}// ************************************************************************** doGetPictureInfoBoolean  doGetPictureInfo(DialogPtr dialogPtr,SInt16 firstPictID){	WindowRef						windowRef;	docStructureHandle	docStrucHdl;	TEHandle						textEditStrucHdl;	Handle							textHdl;	SInt32							offset, textSize;	SInt16							numberOfPicts, a, lineHeight, fontAscent;	SInt8								optionSpace[1] = "\xCA";	pictInfoStructure		*pictInfoPtr;	Point								picturePoint;	TextStyle						whatStyle;	windowRef = GetDialogWindow(dialogPtr);	docStrucHdl = (docStructureHandle) GetWRefCon(windowRef);	if((*docStrucHdl)->pictInfoStructurePtr != NULL)	{		for(a=0;a<(*docStrucHdl)->pictCount;a++)			ReleaseResource((Handle) (*docStrucHdl)->pictInfoStructurePtr[a].pictureHdl);		DisposePtr((Ptr) (*docStrucHdl)->pictInfoStructurePtr);		(*docStrucHdl)->pictInfoStructurePtr = NULL;	}	(*docStrucHdl)->pictCount = 0;	textEditStrucHdl = (*docStrucHdl)->textEditStrucHdl;	textHdl = (*textEditStrucHdl)->hText;	textSize = GetHandleSize(textHdl);	offset = 0;	numberOfPicts = 0;	HLock(textHdl);	offset = Munger(textHdl,offset,optionSpace,1,NULL,0);	while((offset >= 0) && (offset <= textSize))	{		numberOfPicts++;		offset++;		offset = Munger(textHdl,offset,optionSpace,1,NULL,0);			}	if(numberOfPicts == 0)	{		HUnlock(textHdl);		return true;	}	pictInfoPtr = (pictInfoStructure *) NewPtr(sizeof(pictInfoStructure) * numberOfPicts);	(*docStrucHdl)->pictInfoStructurePtr = pictInfoPtr;	offset = 0L;	for(a=0;a<numberOfPicts;a++)	{		pictInfoPtr[a].pictureHdl = GetPicture(firstPictID + a);		if(pictInfoPtr[a].pictureHdl == NULL)		{			doErrorAlert(eHelpPicture);			return false;		}		offset = Munger(textHdl,offset,optionSpace,1,NULL,0);		picturePoint = TEGetPoint((SInt16)offset,textEditStrucHdl);		TEGetStyle(offset,&whatStyle,&lineHeight,&fontAscent,textEditStrucHdl);		picturePoint.v -= lineHeight;		offset++;		pictInfoPtr[a].bounds = (**pictInfoPtr[a].pictureHdl).picFrame;		OffsetRect(&pictInfoPtr[a].bounds,							 (((*textEditStrucHdl)->destRect.right + (*textEditStrucHdl)->destRect.left) -							 (pictInfoPtr[a].bounds.right + pictInfoPtr[a].bounds.left) ) / 2,							 - pictInfoPtr[a].bounds.top + picturePoint.v);	}	(*docStrucHdl)->pictCount = a;	HUnlock(textHdl);	return true;}// **************************************************************************** actionFunctionpascal void  actionFunction(ControlRef scrollbarHdl,SInt16 partCode){	WindowRef						windowRef;	DialogPtr						dialogPtr;	docStructureHandle	docStrucHdl;	TEHandle						textEditStrucHdl;	SInt16							delta, oldValue, offset, lineHeight, fontAscent;	Point								thePoint;	Rect								viewRect, portRect;	TextStyle						style;	if(partCode)	{		windowRef = GetControlOwner(scrollbarHdl);		dialogPtr = GetDialogFromWindow(windowRef);		docStrucHdl = (docStructureHandle) GetWRefCon(windowRef);		textEditStrucHdl = (*docStrucHdl)->textEditStrucHdl;		viewRect = (*textEditStrucHdl)->viewRect;		thePoint.h = viewRect.left + kTextInset;		if(partCode != kControlIndicatorPart)		{			switch(partCode)			{				case kControlUpButtonPart:					thePoint.v = viewRect.top - 4;					offset = TEGetOffset(thePoint,textEditStrucHdl);					thePoint = TEGetPoint(offset,textEditStrucHdl);					TEGetStyle(offset,&style,&lineHeight,&fontAscent,textEditStrucHdl);					delta = thePoint.v - lineHeight - viewRect.top;					break;				case kControlDownButtonPart:					thePoint.v = viewRect.bottom + 2;					offset = TEGetOffset(thePoint,textEditStrucHdl);					thePoint = TEGetPoint(offset,textEditStrucHdl);					delta = thePoint.v - viewRect.bottom;					break;				case kControlPageUpPart:					thePoint.v = viewRect.top + 2;					offset = TEGetOffset(thePoint,textEditStrucHdl);					thePoint = TEGetPoint(offset,textEditStrucHdl);					TEGetStyle(offset,&style,&lineHeight,&fontAscent,textEditStrucHdl);					thePoint.v += lineHeight - fontAscent;					thePoint.v -= viewRect.bottom - viewRect.top;					offset = TEGetOffset(thePoint,textEditStrucHdl);					thePoint = TEGetPoint(offset,textEditStrucHdl);					TEGetStyle(offset,&style,&lineHeight,&fontAscent,textEditStrucHdl);					delta = thePoint.v - viewRect.top;					if(offset == 0)						delta -= lineHeight;					break;								case kControlPageDownPart:					thePoint.v = viewRect.bottom - 2;					offset = TEGetOffset(thePoint,textEditStrucHdl);					thePoint = TEGetPoint(offset,textEditStrucHdl);					TEGetStyle(offset,&style,&lineHeight,&fontAscent,textEditStrucHdl);					thePoint.v -= fontAscent;					thePoint.v += viewRect.bottom - viewRect.top;					offset = TEGetOffset(thePoint,textEditStrucHdl);					thePoint = TEGetPoint(offset,textEditStrucHdl);					TEGetStyle(offset,&style,&lineHeight,&fontAscent,textEditStrucHdl);					delta =  thePoint.v - lineHeight - viewRect.bottom;					if(offset == (**textEditStrucHdl).teLength)						delta += lineHeight;					break;			}			oldValue = GetControlValue(scrollbarHdl);			if(((delta < 0) && (oldValue > 0)) || ((delta > 0) && 				 (oldValue < GetControlMaximum(scrollbarHdl))))			{				GetClip(gSavedClipRgn);				GetWindowPortBounds(windowRef,&portRect);				ClipRect(&portRect);				SetControlValue(scrollbarHdl,oldValue + delta);				SetClip(gSavedClipRgn);			}		}		doScrollTextAndPicts(dialogPtr);	}}// ********************************************************************** doScrollTextAndPictsvoid  doScrollTextAndPicts(DialogPtr dialogPtr){	docStructureHandle	docStrucHdl;	TEHandle						textEditStrucHdl;	SInt16							scrollDistance, oldScroll;	Rect								updateRect;	doSetBackgroundWhite();	docStrucHdl = (docStructureHandle) GetWRefCon(GetDialogWindow(dialogPtr));	textEditStrucHdl = (*docStrucHdl)->textEditStrucHdl;	oldScroll = (*textEditStrucHdl)->viewRect.top -(*textEditStrucHdl)->destRect.top;	scrollDistance = oldScroll - GetControlValue((*docStrucHdl)->scrollbarHdl);	if(scrollDistance == 0)		return;	TEScroll(0,scrollDistance,textEditStrucHdl);	if((*docStrucHdl)->pictCount == 0)		return;			updateRect = (*textEditStrucHdl)->viewRect;	if(scrollDistance > 0)	{		if(scrollDistance < (updateRect.bottom - updateRect.top))			updateRect.bottom = updateRect.top + scrollDistance;	}	else	{		if( - scrollDistance < (updateRect.bottom - updateRect.top))			updateRect.top = updateRect.bottom + scrollDistance;	}	doDrawPictures(dialogPtr,&updateRect);}// **************************************************************************** doDrawPicturesvoid  doDrawPictures(DialogPtr dialogPtr,Rect *updateRect){	docStructureHandle	docStrucHdl;	TEHandle						textEditStrucHdl;	SInt16							pictCount, pictIndex, vOffset;	PicHandle						thePictHdl;	Rect								pictLocRect, dummyRect;	docStrucHdl = (docStructureHandle) GetWRefCon(GetDialogWindow(dialogPtr));	textEditStrucHdl = (*docStrucHdl)->textEditStrucHdl;	vOffset = (*textEditStrucHdl)->destRect.top - (*textEditStrucHdl)->viewRect.top - 						kTextInset;	pictCount = (*docStrucHdl)->pictCount;	for(pictIndex = 0;pictIndex < pictCount;pictIndex++)	{		pictLocRect = (*docStrucHdl)->pictInfoStructurePtr[pictIndex].bounds;    OffsetRect(&pictLocRect,0,vOffset);		if(!SectRect(&pictLocRect,updateRect,&dummyRect))			continue;		thePictHdl = (*docStrucHdl)->pictInfoStructurePtr[pictIndex].pictureHdl;		LoadResource((Handle) thePictHdl);		HLock((Handle) thePictHdl);		GetClip(gSavedClipRgn);		ClipRect(updateRect);		DrawPicture(thePictHdl,&pictLocRect);		SetClip(gSavedClipRgn);		HUnlock((Handle) thePictHdl);	}}// ******************************************************************************* eventFilterpascal Boolean  eventFilter(DialogPtr dialogPtr,EventRecord *eventStrucPtr,SInt16 *itemHit){	Boolean							handledEvent;	GrafPtr							oldPort;	Point								mouseXY;	ControlRef					controlRef;	docStructureHandle	docStrucHdl;	handledEvent = false;	if((eventStrucPtr->what == updateEvt) && 		 ((WindowRef) eventStrucPtr->message != GetDialogWindow(dialogPtr)))	{		doUpdate(eventStrucPtr);	}	else	{		GetPort(&oldPort);		SetPortDialogPort(dialogPtr);		if(eventStrucPtr->what == mouseDown)		{			mouseXY = eventStrucPtr->where;			GlobalToLocal(&mouseXY);			if(FindControl(mouseXY,GetDialogWindow(dialogPtr),&controlRef))			{				docStrucHdl = (docStructureHandle) GetWRefCon(GetDialogWindow(dialogPtr));				if(controlRef == (*docStrucHdl)->scrollbarHdl)				{					TrackControl((*docStrucHdl)->scrollbarHdl,mouseXY,actionFunctionUPP);						*itemHit = iScrollBar;					handledEvent = true;				}			}		}		else		{			handledEvent = StdFilterProc(dialogPtr,eventStrucPtr,itemHit);		}		SetPort(oldPort);	}	return handledEvent;}// ********************************************************************** doSetBackgroundWhitevoid  doSetBackgroundWhite(void){	RGBColor	whiteColour = { 0xFFFF, 0xFFFF, 0xFFFF };	Pattern		whitePattern;	RGBBackColor(&whiteColour);	BackPat(GetQDGlobalsWhite(&whitePattern));}// *******************************************************************************************