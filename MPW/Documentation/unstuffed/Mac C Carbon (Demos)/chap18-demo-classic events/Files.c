// *******************************************************************************************// Files.c// *******************************************************************************************// ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии includes#include "Files.h"// ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии global variablesBoolean			gRunningOnX = false;Boolean			gDone;SInt16			gAppResFileRefNum;NavEventUPP	gGetFilePutFileEventFunctionUPP ;Boolean			gQuittingApplication = false;extern SInt16		gCurrentNumberOfWindows;extern Rect			gDestRect,gViewRect;// ************************************************************************************** mainvoid  main(void){	MenuBarHandle	menubarHdl;	SInt32				response;	MenuRef				menuRef;	// ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии do preliminaries	doPreliminaries();	// ииииииииииииииииииииииииииииииииии save application's resource file file reference number	gAppResFileRefNum = CurResFile();	// иииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии set up menu bar and menus		menubarHdl = GetNewMBar(rMenubar);	if(menubarHdl == NULL)		doErrorAlert(MemError());	SetMenuBar(menubarHdl);	DrawMenuBar();	Gestalt(gestaltMenuMgrAttr,&response);	if(response & gestaltMenuMgrAquaLayoutMask)	{		menuRef = GetMenuRef(mFile);		if(menuRef != NULL)		{			DeleteMenuItem(menuRef,iQuit);			DeleteMenuItem(menuRef,iQuit - 1);		}		gRunningOnX = true;	}	// иииииииииииииииииииииииииииииииииииииииииииииииииии install required Apple event handlers	doInstallAEHandlers();	// иииии get universal procedure pointer to main Navigation Services services event function	gGetFilePutFileEventFunctionUPP  = 																NewNavEventUPP((NavEventProcPtr) getFilePutFileEventFunction);	// ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии enter event loop	eventLoop();}// ********************************************************************************* eventLoopvoid  eventLoop(void){	EventRecord eventStructure;	gDone = false;	while(!gDone)	{		if(WaitNextEvent(everyEvent,&eventStructure,180,NULL))			doEvents(&eventStructure);		else			doSynchroniseFiles();		if(gRunningOnX && gQuittingApplication)			doCloseCommand(kNavSaveChangesQuittingApplication);	}}// *************************************************************************** doPreliminariesvoid  doPreliminaries(void){	MoreMasterPointers(448);	InitCursor();  FlushEvents(everyEvent,0);}// *********************************************************************** doInstallAEHandlersvoid  doInstallAEHandlers(void){	OSErr	osError;	osError = AEInstallEventHandler(kCoreEventClass,kAEOpenApplication,									NewAEEventHandlerUPP((AEEventHandlerProcPtr) openAppEventHandler),									0L,false);	if(osError != noErr)	doErrorAlert(eInstallHandler);	osError = AEInstallEventHandler(kCoreEventClass,kAEReopenApplication,									NewAEEventHandlerUPP((AEEventHandlerProcPtr) reopenAppEventHandler),									0L,false);	if(osError != noErr)	doErrorAlert(eInstallHandler);	osError = AEInstallEventHandler(kCoreEventClass,kAEOpenDocuments,									NewAEEventHandlerUPP((AEEventHandlerProcPtr) openAndPrintDocsEventHandler),									kOpen,false);	if(osError != noErr)	doErrorAlert(eInstallHandler);	osError = AEInstallEventHandler(kCoreEventClass,kAEPrintDocuments,									NewAEEventHandlerUPP((AEEventHandlerProcPtr) openAndPrintDocsEventHandler),									kPrint,false);	if(osError != noErr)	doErrorAlert(eInstallHandler);	osError = AEInstallEventHandler(kCoreEventClass,kAEQuitApplication,									NewAEEventHandlerUPP((AEEventHandlerProcPtr) quitAppEventHandler),									0L,false);	if(osError != noErr)	doErrorAlert(eInstallHandler);}// ********************************************************************************** doEventsvoid	doEvents(EventRecord *eventStrucPtr){	switch(eventStrucPtr->what)	{		case kHighLevelEvent:			AEProcessAppleEvent(eventStrucPtr);			break;		case mouseDown:			doMouseDown(eventStrucPtr);			break;		case keyDown:			if((eventStrucPtr->modifiers & cmdKey) != 0)			{				doAdjustMenus();				doMenuChoice(MenuEvent(eventStrucPtr));			}			break;		case updateEvt:			doUpdate(eventStrucPtr);			break;		case osEvt:			switch((eventStrucPtr->message >> 24) & 0x000000FF)			{				case suspendResumeMessage:					if((eventStrucPtr->message & resumeFlag) == 1)						SetThemeCursor(kThemeArrowCursor);					break;			}			break;	}}// ******************************************************************************* doMouseDownvoid	doMouseDown(EventRecord *eventStrucPtr){	WindowRef				windowRef;	WindowPartCode	partCode;	OSStatus				osStatus;																															 /////	Boolean					handled = false; 																											 /////	SInt32					itemSelected;																													 /////	partCode = FindWindow(eventStrucPtr->where,&windowRef);		switch(partCode)	{		case inMenuBar:			doAdjustMenus();			doMenuChoice(MenuSelect(eventStrucPtr->where));			break;		case inContent:			if(windowRef != FrontWindow())				SelectWindow(windowRef);			break;		case inGoAway:			if(TrackGoAway(windowRef,eventStrucPtr->where) == true)				doCloseCommand(kNavSaveChangesClosingDocument);			break;		case inProxyIcon:																																		 /////			osStatus = TrackWindowProxyDrag(windowRef,eventStrucPtr->where);									 /////			if(osStatus == errUserWantsToDragWindow)																					 /////				handled = false;																																 /////			else if(osStatus == noErr)																												 /////				handled = true;																																	 /////		case inDrag:																																				 /////			if(!handled)																																			 /////			{																																									 /////				if(IsWindowPathSelectClick(windowRef,eventStrucPtr))														 /////				{																																								 /////					if(WindowPathSelect(windowRef,NULL,&itemSelected) == noErr)										 /////					{																																							 /////						if(LoWord(itemSelected) > 1)																								 /////							doBringFinderToFront();																										 /////					}																																							 /////																																												 /////					handled = true;																																 /////				}																																								 /////			}																																									 /////			if(!handled)																																			 /////				DragWindow(windowRef,eventStrucPtr->where,NULL);																 /////			break;	}}// ********************************************************************** doBringFinderToFrontvoid  doBringFinderToFront(void)																												 /////{																																												 /////	ProcessSerialNumber	finderProcess;																										 /////																																												 /////	if(doFindProcess('MACS','FNDR',&finderProcess) == noErr)															 /////		SetFrontProcess(&finderProcess);																										 /////	else																																									 /////		doErrorAlert(eCantFindFinderProcess);																								 /////}																																												 /////// ***************************************************************************** doFindProcessOSErr  doFindProcess(OSType creator,OSType type,ProcessSerialNumber *outProcSerNo){																																												 /////	ProcessSerialNumber	procSerialNo;																											 /////	ProcessInfoRec			procInfoStruc;																										 /////	OSErr								osError = 0;																											 /////																																												 /////	procSerialNo.highLongOfPSN = 0;																												 /////	procSerialNo.lowLongOfPSN	 = kNoProcess;																							 /////																																												 /////	procInfoStruc.processInfoLength	= sizeof(ProcessInfoRec);															 /////	procInfoStruc.processName				= NULL;																								 /////	procInfoStruc.processAppSpec		= NULL;																								 /////	procInfoStruc.processLocation		= NULL;																								 /////																																												 /////	while(true)																																						 /////	{																																											 /////		osError = GetNextProcess(&procSerialNo);																						 /////		if(osError != noErr)																																 /////			break;																																						 /////																																												 /////		osError = GetProcessInformation(&procSerialNo,&procInfoStruc);											 /////		if(osError != noErr)																																 /////			break;																																						 /////		if((procInfoStruc.processSignature == creator) && (procInfoStruc.processType == type)) ///			break;																																						 /////	}																																											 /////																																												 /////	*outProcSerNo = procSerialNo;																													 /////																																												 /////		return osError;																																				 /////}																																												 /////// ********************************************************************************** doUpdatevoid  doUpdate(EventRecord *eventStrucPtr){	WindowRef						windowRef;	docStructureHandle	docStrucHdl;	GrafPtr							oldPort;	Rect								destRect;	windowRef = (WindowRef) eventStrucPtr->message;	docStrucHdl = (docStructureHandle) GetWRefCon(windowRef);	GetPort(&oldPort);	SetPortWindowPort(windowRef);	BeginUpdate(windowRef);	if((*docStrucHdl)->pictureHdl)	{		destRect = (*(*docStrucHdl)->pictureHdl)->picFrame;		OffsetRect(&destRect,170,54);		HLock((Handle) (*docStrucHdl)->pictureHdl);		DrawPicture((*docStrucHdl)->pictureHdl,&destRect);		HUnlock((Handle) (*docStrucHdl)->pictureHdl);	}	else if((*docStrucHdl)->editStrucHdl)	{		HLock((Handle) (*docStrucHdl)->editStrucHdl);		TEUpdate(&gDestRect,(*docStrucHdl)->editStrucHdl);		HUnlock((Handle) (*docStrucHdl)->editStrucHdl);	}	if((*docStrucHdl)->windowTouched)	{		TextSize(48);		MoveTo(30,170);		DrawString("\pWINDOW TOUCHED");		TextSize(12);	}	EndUpdate((WindowRef) eventStrucPtr->message);	SetPort(oldPort);}// ****************************************************************************** doMenuChoicevoid  doMenuChoice(SInt32 menuChoice){	MenuID				menuID;	MenuItemIndex	menuItem;	OSErr					osError;	MenuCommand		commandID;	menuID = HiWord(menuChoice);	menuItem = LoWord(menuChoice);	if(menuID == 0)		return;	if(menuID == mAppleApplication)	{		if(menuItem == iAbout)			SysBeep(10);	}	else	{		osError = GetMenuItemCommandID(GetMenuRef(menuID),menuItem,&commandID);		if(osError == noErr && commandID != 0)			doCommand(commandID);	}	HiliteMenu(0);}// ********************************************************************************* doCommandvoid  doCommand(MenuCommand commandID){	OSErr	osError;	switch(commandID)	{		// иииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии File menu		case File_New:			if(osError = doNewCommand())				doErrorAlert(osError);			break;		case File_Open:			if(osError = doOpenCommand())				doErrorAlert(osError);			break;		case File_Close:			if(osError = doCloseCommand(kNavSaveChangesClosingDocument))				doErrorAlert(osError);			break;		case File_Save:			if(osError = doSaveCommand())				doErrorAlert(osError);			break;		case File_SaveAs:			if(osError = doSaveAsCommand())				doErrorAlert(osError);			break;		case File_Revert:			if(osError = doRevertCommand())				doErrorAlert(osError);			break;		case File_Quit:			gQuittingApplication = true;			doCloseCommand(kNavSaveChangesQuittingApplication);			break;		// ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии Demonstration menu		case Demo_TouchWindow:			doTouchWindow();			break;					case Demo_ChooseAFolderDialog:			if(osError = doChooseAFolderDialog())				doErrorAlert(osError);			break;	}}// ***************************************************************************** doAdjustMenusvoid  doAdjustMenus(void){	OSErr								osError;	MenuRef							menuRef;	WindowRef						windowRef;	docStructureHandle	docStrucHdl;	if(gCurrentNumberOfWindows > 0)	{		if(gRunningOnX)		{				if((osError = GetSheetWindowParent(FrontWindow(),&windowRef)) == noErr)			{				menuRef = GetMenuRef(mFile);				DisableMenuCommand(menuRef,File_Close);				DisableMenuCommand(menuRef,File_Save);				DisableMenuCommand(menuRef,File_SaveAs);				DisableMenuCommand(menuRef,File_Revert);				menuRef = GetMenuRef(mDemonstration);				DisableMenuCommand(menuRef,Demo_TouchWindow);				return;			}			else				windowRef = FrontWindow();		}		else			windowRef = FrontWindow();		if(GetWindowKind(windowRef) == kApplicationWindowKind)		{			docStrucHdl = (docStructureHandle) GetWRefCon(windowRef);			menuRef = GetMenuRef(mFile);			EnableMenuCommand(menuRef,File_Close);			if((*docStrucHdl)->windowTouched)			{				EnableMenuCommand(menuRef,File_Save);				EnableMenuCommand(menuRef,File_Revert);			}			else			{				DisableMenuCommand(menuRef,File_Save);				DisableMenuCommand(menuRef,File_Revert);			}			if(((*docStrucHdl)->pictureHdl != NULL) || 				 ((*(*docStrucHdl)->editStrucHdl)->teLength > 0))				EnableMenuCommand(menuRef,File_SaveAs);			else				DisableMenuCommand(menuRef,File_SaveAs);			menuRef = GetMenuRef(mDemonstration);			if(((*docStrucHdl)->pictureHdl != NULL) || 				 ((*(*docStrucHdl)->editStrucHdl)->teLength > 0))			{				if((*docStrucHdl)->windowTouched == false)					EnableMenuCommand(menuRef,Demo_TouchWindow);				else					DisableMenuCommand(menuRef,Demo_TouchWindow);			}			else				DisableMenuCommand(menuRef,Demo_TouchWindow);		}	}	else	{		menuRef = GetMenuRef(mFile);		DisableMenuCommand(menuRef,File_Close);		DisableMenuCommand(menuRef,File_Save);		DisableMenuCommand(menuRef,File_SaveAs);		DisableMenuCommand(menuRef,File_Revert);		menuRef = GetMenuRef(mDemonstration);		DisableMenuCommand(menuRef,Demo_TouchWindow);	}	DrawMenuBar();}	// ****************************************************************************** doErrorAlertvoid  doErrorAlert(SInt16 errorCode){	Str255	errorString, theString;	SInt16	itemHit;	if(errorCode == eInstallHandler)		GetIndString(errorString,rErrorStrings,1);	else if(errorCode == eMaxWindows)		GetIndString(errorString,rErrorStrings,2);	else if(errorCode == eCantFindFinderProcess)		GetIndString(errorString,rErrorStrings,3);	else if(errorCode == opWrErr)		GetIndString(errorString,rErrorStrings,4);	else	{		GetIndString(errorString,rErrorStrings,5);		NumToString((SInt32) errorCode,theString);		doConcatPStrings(errorString,theString);	}	if(errorCode != memFullErr)	{		StandardAlert(kAlertCautionAlert,errorString,NULL,NULL,&itemHit);	}	else	{		StandardAlert(kAlertStopAlert,errorString,NULL,NULL,&itemHit);		ExitToShell();	}}// ***************************************************************************** doCopyPStringvoid  doCopyPString(Str255 sourceString,Str255 destinationString){	SInt16	stringLength;	stringLength = sourceString[0];	BlockMove(sourceString + 1,destinationString + 1,stringLength);	destinationString[0] = stringLength;}// ************************************************************************** doConcatPStringsvoid  doConcatPStrings(Str255 targetString,Str255 appendString){	SInt16	appendLength;	appendLength = MIN(appendString[0],255 - targetString[0]);	if(appendLength > 0)	{		BlockMoveData(appendString+1,targetString+targetString[0]+1,(SInt32) appendLength);		targetString[0] += appendLength;	}}// ***************************************************************************** doTouchWindowvoid	doTouchWindow(void){	WindowRef						windowRef;	docStructureHandle	docStrucHdl;	windowRef = FrontWindow();	docStrucHdl = (docStructureHandle) GetWRefCon(windowRef);	SetPortWindowPort(windowRef);		TextSize(48);	MoveTo(30,170);	DrawString("\pWINDOW TOUCHED");	TextSize(12);	(*docStrucHdl)->windowTouched = true;	SetWindowModified(windowRef,true);																										 /////}// *********************************************************************** openAppEventHandlerOSErr  openAppEventHandler(AppleEvent *appEvent,AppleEvent *reply,SInt32 handlerRefCon){	OSErr	osError;	osError = doHasGotRequiredParams(appEvent);	if(osError == noErr)		osError = doNewCommand();	return osError;}// ********************************************************************* reopenAppEventHandlerOSErr  reopenAppEventHandler(AppleEvent *appEvent,AppleEvent *reply,															 SInt32 handlerRefCon){	OSErr	osError;	osError = doHasGotRequiredParams(appEvent);	if(osError == noErr)		if(!FrontWindow())			osError = doNewCommand();	return osError;}// ************************************************************** openAndPrintDocsEventHandlerOSErr  openAndPrintDocsEventHandler(AppleEvent *appEvent,AppleEvent *reply,																		SInt32 handlerRefcon){	FSSpec			fileSpec;	AEDescList	docList;	OSErr				osError, ignoreErr;	SInt32			index, numberOfItems;	Size				actualSize;	AEKeyword		keyWord;	DescType		returnedType;	FInfo				fileInfo;	osError = AEGetParamDesc(appEvent,keyDirectObject,typeAEList,&docList);	if(osError == noErr)	{		osError = doHasGotRequiredParams(appEvent);		if(osError == noErr)		{			osError = AECountItems(&docList,&numberOfItems);			if(osError == noErr)			{				for(index=1;index<=numberOfItems;index++)				{					osError = AEGetNthPtr(&docList,index,typeFSS,&keyWord,&returnedType,																&fileSpec,sizeof(fileSpec),&actualSize);					if(osError == noErr)					{						osError = FSpGetFInfo(&fileSpec,&fileInfo);						if(osError == noErr)						{							if(osError = doOpenFile(fileSpec,fileInfo.fdType))								doErrorAlert(osError);							if(osError == noErr && handlerRefcon == kPrint)							{								// Call printing function here							}						}					}					else						doErrorAlert(osError);				}			}		}		else			doErrorAlert(osError);		ignoreErr = AEDisposeDesc(&docList);	}	else		doErrorAlert(osError);	return osError;}// *********************************************************************** quitAppEventHandlerOSErr  quitAppEventHandler(AppleEvent *appEvent,AppleEvent *reply,SInt32 handlerRefcon){	OSErr								osError;	WindowRef						windowRef, previousWindowRef;	docStructureHandle	docStrucHdl;	SInt16							touchedWindowsCount = 0;	SInt16							itemHit;	osError = doHasGotRequiredParams(appEvent);	if(osError == noErr)	{		if(!gRunningOnX)		{			gQuittingApplication = true;			doCloseCommand(kNavSaveChangesQuittingApplication);		}		else		{			// ииииии if any window has a sheet, bring to front, play system alert sound, and return			windowRef = GetFrontWindowOfClass(kSheetWindowClass,true);			if(windowRef)			{				SelectWindow(windowRef);				SysBeep(10);				return noErr;			}			// иииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии count touched windows			windowRef = FrontWindow();			do			{				docStrucHdl = (docStructureHandle) GetWRefCon(windowRef);				if((*docStrucHdl)->windowTouched == true)					touchedWindowsCount++;				previousWindowRef = windowRef;			} while(windowRef = GetNextWindowOfClass(previousWindowRef,kDocumentWindowClass,true));			// ииииииииииииииииииииииииииииииииииииииииииии if no touched windows, simply close down			if(touchedWindowsCount == 0)				gDone = true;			// ииии if one touched window, cause Save Changes alert on that window, close all others			if(touchedWindowsCount == 1)				gQuittingApplication = true;			// ии if more than one touched window, create Review Unsaved alert, handle button clicks			else if(touchedWindowsCount > 1)			{				itemHit = doReviewChangesAlert(touchedWindowsCount);				if(itemHit == kAlertStdAlertOKButton)					gQuittingApplication = true;				else if(itemHit == kAlertStdAlertCancelButton)					gQuittingApplication = false;				else if(itemHit == kAlertStdAlertOtherButton)					gDone = true;			}		}		}		return noErr;}// ******************************************************************** doHasGotRequiredParamsOSErr  doHasGotRequiredParams(AppleEvent *appEvent){	DescType	returnedType;	Size			actualSize;	OSErr			osError;	osError = AEGetAttributePtr(appEvent,keyMissedKeywordAttr,typeWildCard,&returnedType,														NULL,0,&actualSize);	if(osError == errAEDescNotFound)		osError = noErr;	else if(osError == noErr)		osError = errAEParamMissed;	return osError;}// ********************************************************************** doReviewChangesAlertSInt16  doReviewChangesAlert(SInt16 touchedWindowsCount){	AlertStdCFStringAlertParamRec	paramRec;	Str255			messageText1 = "\pYou have ";	Str255			messageText2 = "\p Files documents with unsaved changes. ";	Str255			messageText3 = "\pDo you want to review these changes before quitting?";	Str255			countString;	CFStringRef	messageText;	CFStringRef	informativeText = 							CFSTR("If you don't review your documents, all your changes will be lost.");	DialogRef				dialogRef;	DialogItemIndex	itemHit;	NumToString(touchedWindowsCount,countString);	doConcatPStrings(messageText1,countString);		doConcatPStrings(messageText1,messageText2);		doConcatPStrings(messageText1,messageText3);	  messageText = CFStringCreateWithPascalString(NULL,messageText1,CFStringGetSystemEncoding());	GetStandardAlertDefaultParams(&paramRec,kStdCFStringAlertVersionOne);	paramRec.movable			= true;	paramRec.defaultText	= CFSTR("Review Changesи");	paramRec.cancelText		= CFSTR("Cancel");	paramRec.otherText		= CFSTR("Discard Changes");	CreateStandardAlert(kAlertStopAlert,messageText,informativeText,&paramRec,&dialogRef);	RunStandardAlert(dialogRef,NULL,&itemHit);	if(messageText != NULL)		CFRelease(messageText);	return itemHit;}// *******************************************************************************************