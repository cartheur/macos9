// *******************************************************************************************// CarbonEvents2.c// *******************************************************************************************// ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии includes#include "CarbonEvents2.h"// ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии global variablesControlActionUPP	gActionFunctionVertUPP;ControlActionUPP	gActionFunctionHorizUPP;Boolean						gRunningOnX = false;SInt16						gNumberOfWindows = 0;Str255						gCurrentString;SInt16						gTypingTarget = 3;// ************************************************************************************** mainvoid  main(void){	MenuBarHandle			menubarHdl;	SInt32						response;	MenuRef						menuRef;	EventLoopTimerUPP	eventLoopTimerUPP;	EventTypeSpec		applicationEvents[] =	{ { kEventClassApplication, kEventAppActivated    },																					{ kEventClassApplication, kEventAppDeactivated  },																					{ kEventClassCommand,     kEventProcessCommand  },																					{ kEventClassMenu,        kEventMenuEnableItems },																			 		{ kEventClassMouse,       kEventMouseMoved      } };	// ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии do preliminaries	doPreliminaries();	// иииииииииииииииииииииииииииииииииииииииииииииииииииии create universal procedure pointers	gActionFunctionVertUPP	= NewControlActionUPP((ControlActionProcPtr) actionFunctionVert);	gActionFunctionHorizUPP = NewControlActionUPP((ControlActionProcPtr) actionFunctionHoriz);	// иииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии set up menu bar and menus	menubarHdl = GetNewMBar(rMenubar);	if(menubarHdl == NULL)		ExitToShell();	SetMenuBar(menubarHdl);	CreateStandardWindowMenu(0,&menuRef);	SetMenuID(menuRef,mWindow);	InsertMenu(menuRef,0);	DrawMenuBar();	Gestalt(gestaltMenuMgrAttr,&response);	if(response & gestaltMenuMgrAquaLayoutMask)	{		menuRef = GetMenuRef(mFile);		if(menuRef != NULL)		{			DeleteMenuItem(menuRef,iQuit);			DeleteMenuItem(menuRef,iQuit - 1);		}		gRunningOnX = true;	}	else	{		menuRef = GetMenuRef(mFile);		if(menuRef != NULL)			SetMenuItemCommandID(menuRef,iQuit,kHICommandQuit);		menuRef = GetMenuRef(mDialogs);		if(menuRef != NULL)		{			DisableMenuItem(menuRef,iSheetAlert);			DisableMenuItem(menuRef,iSheetDialog);		}	}	// иииииииииииииииииииииииииииииииииииииииииииииииии initial advisory text for window header	doCopyPString("\pManipulate the window and controls.  Do typing.",gCurrentString);	// иииииииииииииииииииииииииииииииииииииииииииииииииииииии install application event handler  	InstallApplicationEventHandler(NewEventHandlerUPP((EventHandlerProcPtr) appEventHandler),																 GetEventTypeCount(applicationEvents),applicationEvents,																 0,NULL);	// иииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии install timer	eventLoopTimerUPP = NewEventLoopTimerUPP((EventLoopTimerProcPtr) doIdle);	InstallEventLoopTimer(GetCurrentEventLoop(),0,TicksToEventTime(GetCaretTime()),												eventLoopTimerUPP,NULL,NULL);	// иииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии open window	doNewWindow();	// ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии run application event loop	RunApplicationEventLoop();}// *************************************************************************** doPreliminariesvoid  doPreliminaries(void){	MoreMasterPointers(128);	InitCursor();}// *************************************************************************** appEventHandlerOSStatus  appEventHandler(EventHandlerCallRef eventHandlerCallRef,EventRef eventRef,													void * userData){	OSStatus			result = eventNotHandledErr;	UInt32				eventClass;	UInt32 				eventKind;	HICommand			hiCommand;	MenuID				menuID;	MenuItemIndex	menuItem;	WindowClass		windowClass;	eventClass = GetEventClass(eventRef);	eventKind  = GetEventKind(eventRef);	switch(eventClass)	{		case kEventClassApplication:			if(eventKind == kEventAppActivated)				SetThemeCursor(kThemeArrowCursor);			break;		case kEventClassCommand:			if(eventKind == kEventProcessCommand)			{				GetEventParameter(eventRef,kEventParamDirectObject,typeHICommand,NULL,													sizeof(HICommand),NULL,&hiCommand);				if(hiCommand.commandID == kHICommandQuit)					result = eventNotHandledErr;				menuID = GetMenuID(hiCommand.menu.menuRef);				menuItem = hiCommand.menu.menuItemIndex;				if((hiCommand.commandID != kHICommandQuit) && 					 (menuID >= mAppleApplication && menuID <= mDialogs))				{					doMenuChoice(menuID,menuItem);					result = noErr;				}				if(hiCommand.commandID == kPopupCountryID)				{					doControlHit2();					result = noErr;				}			}			break;		case kEventClassMenu:			if(eventKind == kEventMenuEnableItems)			{				GetWindowClass(FrontWindow(),&windowClass);				if(windowClass == kDocumentWindowClass)					doAdjustMenus();				result = noErr;			}			break;		case kEventClassMouse:			if(eventKind == kEventMouseMoved)			{				GetWindowClass(FrontWindow(),&windowClass);				if(windowClass == kDocumentWindowClass)					doAdjustCursor(FrontWindow());				result = noErr;			}			break;	}	return result;}// ************************************************************************ windowEventHandlerOSStatus  windowEventHandler(EventHandlerCallRef eventHandlerCallRef,EventRef eventRef,														 void* userData){	OSStatus				result = eventNotHandledErr;	UInt32					eventClass;	UInt32					eventKind;	WindowRef				windowRef;	Rect						mainScreenRect, portRect;	BitMap					screenBits;	Point						idealHeightAndWidth, minimumHeightAndWidth, mouseLocation;	ControlRef			controlRef;	ControlPartCode	controlPartCode;	SInt8						charCode;	UInt32					modifiers; 	HICommand				hiCommand;	eventClass = GetEventClass(eventRef);	eventKind  = GetEventKind(eventRef);	switch(eventClass)	{		case kEventClassWindow:																							 // event class window			GetEventParameter(eventRef,kEventParamDirectObject,typeWindowRef,NULL,sizeof(windowRef),												NULL,&windowRef);			switch(eventKind)			{				case kEventWindowDrawContent:					doDrawContent(windowRef);					break;				case kEventWindowActivated:					doActivateDeactivate(windowRef,true);					break;				case kEventWindowDeactivated:					doActivateDeactivate(windowRef,false);					break;				case kEventWindowGetIdealSize:					mainScreenRect = GetQDGlobalsScreenBits(&screenBits)->bounds;					idealHeightAndWidth.v = mainScreenRect.bottom - 75;					idealHeightAndWidth.h = 600;					SetEventParameter(eventRef,kEventParamDimensions,typeQDPoint,														sizeof(idealHeightAndWidth),&idealHeightAndWidth); 					result = noErr;					break;				case kEventWindowGetMinimumSize:					minimumHeightAndWidth.v = 308; 					minimumHeightAndWidth.h = 290;					SetEventParameter(eventRef,kEventParamDimensions,typeQDPoint,														sizeof(minimumHeightAndWidth),&minimumHeightAndWidth);					result = noErr;					break;				case kEventWindowZoomed:					GetWindowPortBounds(windowRef,&portRect);					EraseRect(&portRect);					doAdjustScrollBars(windowRef);					result = noErr;					break;				case kEventWindowBoundsChanged:					doAdjustScrollBars(windowRef);					doDrawMessage(windowRef,true);					result = noErr;					break;				case kEventWindowClose:					doCloseWindow(windowRef);					break;			}			break;		case kEventClassControl:																						// event class control			switch(eventKind)			{				case kEventControlClick:					GetEventParameter(eventRef,kEventParamMouseLocation,typeQDPoint,NULL,														sizeof(mouseLocation),NULL,&mouseLocation);					SetPortWindowPort(FrontWindow());					GlobalToLocal(&mouseLocation);					controlRef = FindControlUnderMouse(mouseLocation,FrontWindow(),&controlPartCode);					if(controlRef)					{						doControlHit1(FrontWindow(),controlRef,mouseLocation,controlPartCode);						result = noErr;					}					break;			}			break;		case kEventClassKeyboard:																					 // event class keyboard			switch(eventKind)			{				case kEventRawKeyDown:					if(gTypingTarget == 1 || gTypingTarget == 3)					{						GetEventParameter(eventRef,kEventParamKeyMacCharCodes,typeChar,NULL,															sizeof(charCode),NULL,&charCode);						GetEventParameter(eventRef,kEventParamKeyModifiers,typeUInt32,NULL,															sizeof(modifiers),NULL,&modifiers);						doDrawDocumentTyping(charCode,modifiers);					}					if(gTypingTarget == 1)						result = noErr;					break;			}			break;		case kEventClassCommand:																						// event class command			if(eventKind == kEventProcessCommand)			{				GetEventParameter(eventRef,kEventParamDirectObject,typeHICommand,NULL,													sizeof(HICommand),NULL,&hiCommand);				if(hiCommand.commandID == kHICommandOK)					doCopyPString("\pOK button hit",gCurrentString);				if(hiCommand.commandID == kHICommandCancel)					doCopyPString("\pCancel button hit",gCurrentString);				if(hiCommand.commandID == kHICommandOther)					doCopyPString("\pOther button hit",gCurrentString);				GetWindowPortBounds(FrontWindow(),&portRect);				InvalWindowRect(FrontWindow(),&portRect);			}			break;	}	return result;}// ******************************************************************************* doNewWindowvoid  doNewWindow(void){	WindowRef				windowRef;	Str255					windowTitleString = "\pCarbonEvents2 - ";	Str255					theString;	docStrucHandle	docStrucHdl;	SInt16					a;	MenuRef					menuRef;	EventTypeSpec		windowEvents[] = { { kEventClassWindow,	  kEventWindowDrawContent    },																		 { kEventClassWindow,	  kEventWindowActivated      },																		 { kEventClassWindow,  	kEventWindowDeactivated    },																		 { kEventClassWindow,  	kEventWindowGetIdealSize   },																		 { kEventClassWindow,  	kEventWindowGetMinimumSize },																		 { kEventClassWindow,   kEventWindowZoomed         },																		 { kEventClassWindow,  	kEventWindowBoundsChanged  },																		 { kEventClassWindow,   kEventWindowClose          },																		 { kEventClassControl,  kEventControlClick         },																		 { kEventClassKeyboard, kEventRawKeyDown           },																		 { kEventClassCommand,  kEventProcessCommand       } };	// ииииииииииииииииииииииииииииииииииииииииииииииииииииииииии open window and set attributes	if(!(windowRef = GetNewCWindow(rWindow,NULL,(WindowRef) -1)))		ExitToShell();	ChangeWindowAttributes(windowRef,kWindowStandardHandlerAttribute,0);	if(gRunningOnX)		ChangeWindowAttributes(windowRef,kWindowLiveResizeAttribute,0);	// ииииииииииииииииииииииииииииииииииииииииииииии alternative open window and set attributes	// Rect							contentRect = { 100,100,405,393 };	// WindowAttributes	attributes  = kWindowStandardHandlerAttribute |	//																kWindowStandardDocumentAttributes |	//																kWindowLiveResizeAttribute;	//	// CreateNewWindow(kDocumentWindowClass,attributes,&contentRect,&windowRef);	// RepositionWindow(windowRef,NULL,kWindowAlertPositionOnMainScreen);		// иииииииииии get block for document structure, assign handle to window record refCon field	if(!(docStrucHdl = (docStrucHandle) NewHandle(sizeof(docStruc))))		ExitToShell();	// ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии set window title	SetWRefCon(windowRef,(SInt32) docStrucHdl);	gNumberOfWindows ++;	NumToString(gNumberOfWindows,theString);	doConcatPStrings(windowTitleString,theString);	SetWTitle(windowRef,windowTitleString);	SetPortWindowPort(windowRef);	TextSize(46);	// ииииииииииииииииииииииииииии if running on Mac OS 8/9, set theme-compliant colour/pattern	SetThemeWindowBackground(windowRef,kThemeBrushDialogBackgroundActive,false);	// ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии install window event handler	InstallWindowEventHandler(windowRef,doGetHandlerUPP(),GetEventTypeCount(windowEvents),														windowEvents,0,NULL);	// иииииииииииииииииииииииииииииииииииииии get controls, adjust scroll bars, and show window	doGetControls(windowRef);	doAdjustScrollBars(windowRef);	ShowWindow(windowRef);	// иииииииииииииииииииии enable Typing and Window menu, fix typing target and keyboard focus	menuRef = GetMenuRef(mTyping);	EnableMenuItem(menuRef,0);	for(a = iDocument;a <= iAllOfTheAbove;a ++)		CheckMenuItem(menuRef,a,false);	CheckMenuItem(menuRef,iAllOfTheAbove,true);	SetKeyboardFocus(windowRef,(*docStrucHdl)->editTextRef,kControlFocusNextPart);	gTypingTarget = 3;		EnableMenuItem(GetMenuRef(mWindow),0);}// *************************************************************************** doGetHandlerUPPEventHandlerUPP  doGetHandlerUPP(void){	static EventHandlerUPP	windowEventHandlerUPP;	if(windowEventHandlerUPP == NULL)		windowEventHandlerUPP = NewEventHandlerUPP((EventHandlerProcPtr) windowEventHandler);	return windowEventHandlerUPP;}// ***************************************************************************** doCloseWindowvoid  doCloseWindow(WindowRef windowRef){	docStrucHandle	docStrucHdl;	KillControls(windowRef);	docStrucHdl = (docStrucHandle) (GetWRefCon(windowRef));	DisposeHandle((Handle) docStrucHdl);	gNumberOfWindows --;	if(gNumberOfWindows == 0)	{		DisableMenuItem(GetMenuRef(mTyping),0);		DisableMenuItem(GetMenuRef(mWindow),0);	}}// ***************************************************************************** doGetControlsvoid  doGetControls(WindowRef windowRef){	ControlRef			controlRef;	docStrucHandle	docStrucHdl;	OSStatus				osError;	Rect 						controlRect;	Boolean					booleanData = true;	CreateRootControl(windowRef,&controlRef);	docStrucHdl = (docStrucHandle) (GetWRefCon(windowRef));	SetRect(&controlRect,40,40,235,60);	if((osError = CreatePopupButtonControl(windowRef,&controlRect,CFSTR("Time Zone:"),133,false,																				 -1,0,0,&(*docStrucHdl)->popupTimeZoneRef)) != noErr)		ExitToShell();	SetRect(&controlRect,55,73,235,93);	if((osError = CreatePopupButtonControl(windowRef,&controlRect,CFSTR("Country:"),134,false,																				 -1,0,0,&(*docStrucHdl)->popupCountryRef)) != noErr)		ExitToShell();	SetRect(&controlRect,35,126,91,144);	if((osError = CreateRadioButtonControl(windowRef,&controlRect,CFSTR("Red"),1,false,																				 &(*docStrucHdl)->radiobuttonRedRef)) != noErr)		ExitToShell();	SetRect(&controlRect,35,148,91,166);	if((osError = CreateRadioButtonControl(windowRef,&controlRect,CFSTR("White"),0,false,																				 &(*docStrucHdl)->radiobuttonWhiteRef)) != noErr)		ExitToShell();	SetRect(&controlRect,35,170,91,188);	if((osError = CreateRadioButtonControl(windowRef,&controlRect,CFSTR("Blue"),0,false,																				 &(*docStrucHdl)->radiobuttonBlueRef)) != noErr)		ExitToShell();	SetRect(&controlRect,20,102,107,201);	if((osError = CreateGroupBoxControl(windowRef,&controlRect,CFSTR("Colour"),true,																			&(*docStrucHdl)->groupboxColourRef)) != noErr)		ExitToShell();	SetRect(&controlRect,123,102,255,201);	if((osError = CreateGroupBoxControl(windowRef,&controlRect,CFSTR("Typing"),true,																			&(*docStrucHdl)->groupboxTypingRef)) != noErr)		ExitToShell();	SetRect(&controlRect,63,213,132,233);	if((osError = CreatePushButtonControl(windowRef,&controlRect,CFSTR("Cancel"),																				&(*docStrucHdl)->buttonRef)) != noErr)		ExitToShell();	SetRect(&controlRect,144,213,213,233);	if((osError = CreatePushButtonControl(windowRef,&controlRect,CFSTR("OK"),																				&(*docStrucHdl)->buttonDefaultRef)) != noErr)		ExitToShell();	SetRect(&controlRect,26,251,249,267);	if((osError = CreateEditTextControl(windowRef,&controlRect,NULL,false,true,NULL,																			&(*docStrucHdl)->editTextRef)) != noErr)		ExitToShell();	SetRect(&controlRect,0,0,16,262);	if((osError = CreateScrollBarControl(windowRef,&controlRect,0,0,125,0,false,NULL,																			 &(*docStrucHdl)->scrollbarVertRef)) != noErr)		ExitToShell();	SetRect(&controlRect,0,0,245,16);	if((osError = CreateScrollBarControl(windowRef,&controlRect,0,0,125,0,true,NULL,																			 &(*docStrucHdl)->scrollbarHorizRef)) != noErr)		ExitToShell();	AutoEmbedControl((*docStrucHdl)->radiobuttonRedRef,windowRef);	AutoEmbedControl((*docStrucHdl)->radiobuttonWhiteRef,windowRef);	AutoEmbedControl((*docStrucHdl)->radiobuttonBlueRef,windowRef);	SetControlCommandID((*docStrucHdl)->popupCountryRef,kPopupCountryID);	SetControlData((*docStrucHdl)->buttonDefaultRef,kControlEntireControl,								 kControlPushButtonDefaultTag,sizeof(booleanData),&booleanData);}// ************************************************************************************ doIdlevoid  doIdle(void){	if(!gRunningOnX)		IdleControls(FrontWindow());}// ***************************************************************************** doAdjustMenusvoid  doAdjustMenus(void){	MenuRef		menuRef;	OSStatus	osError;	WindowRef	windowRef;	if(FrontWindow())	{		menuRef = GetMenuRef(mFile);		EnableMenuItem(menuRef,iClose);		menuRef = GetMenuRef(mTyping);		EnableMenuItem(menuRef,0);	}	else	{		menuRef = GetMenuRef(mFile);		DisableMenuItem(menuRef,iClose);		menuRef = GetMenuRef(mTyping);		DisableMenuItem(menuRef,0);	}	if(gRunningOnX)	{		if((osError = GetSheetWindowParent(FrontWindow(),&windowRef)) == noErr)		{			menuRef = GetMenuRef(mFile);			DisableMenuItem(menuRef,iClose);			menuRef = GetMenuRef(mTyping);			DisableMenuItem(menuRef,0);		}		else		{			if(FrontWindow())			{				menuRef = GetMenuRef(mTyping);				EnableMenuItem(menuRef,0);			}		}		menuRef = GetMenuRef(mDialogs);		if(((osError = GetSheetWindowParent(FrontWindow(),&windowRef)) == noErr) || 			 (FrontWindow() == NULL) || IsWindowCollapsed(FrontWindow()))		{			DisableMenuItem(menuRef,iSheetAlert);			DisableMenuItem(menuRef,iSheetDialog);		}		else		{			EnableMenuItem(menuRef,iSheetAlert);			EnableMenuItem(menuRef,iSheetDialog);		}	}}// ****************************************************************************** doMenuChoicevoid  doMenuChoice(MenuID menuID,MenuItemIndex menuItem){	WindowRef				windowRef;	SInt16					a;	MenuRef					menuRef;	docStrucHandle	docStrucHdl;	if(menuID == 0)		return;	windowRef = FrontWindow();	switch(menuID)	{		case mAppleApplication:			if(menuItem == iAbout)				SysBeep(10);			break;		case mFile:			if(menuItem == iNew)				doNewWindow();			else if(menuItem == iClose)			{				doCloseWindow(windowRef);				DisposeWindow(windowRef);			}			break;		case mTyping:			menuRef = GetMenuRef(mTyping);			for(a = iDocument;a <= iAllOfTheAbove;a ++)				CheckMenuItem(menuRef,a,false);			CheckMenuItem(menuRef,menuItem,true);			gTypingTarget = menuItem;			docStrucHdl = (docStrucHandle) (GetWRefCon(windowRef));			if(menuItem == iDocument)				SetKeyboardFocus(windowRef,(*docStrucHdl)->editTextRef,kControlFocusNoPart);			else				SetKeyboardFocus(windowRef,(*docStrucHdl)->editTextRef,kControlFocusNextPart);			break;		case mDialogs:			if(menuItem == iMovableModal)				if(doMovableModalDialog() != noErr)					ExitToShell();			if(menuItem == iSheetAlert)				if(doSheetAlert() != noErr)					ExitToShell();			if(menuItem == iSheetDialog)				if(doSheetDialog() != noErr)					ExitToShell();			break;	}}// ***************************************************************************** doDrawContentvoid  doDrawContent(WindowRef windowRef){	SetPortWindowPort(windowRef);	doDrawMessage(windowRef,windowRef == FrontWindow());}// ************************************************************************** doActivateWindowvoid  doActivateDeactivate(WindowRef windowRef,Boolean becomingActive){	if(becomingActive)		doDrawMessage(windowRef,becomingActive);	else		doDrawMessage(windowRef,becomingActive);}// ***************************************************************************** doControlHit1void  doControlHit1(WindowRef windowRef,ControlRef controlRef,Point mouseLocation,									 ControlPartCode controlPartCode){	docStrucHandle	docStrucHdl;	SInt16					controlValue;	docStrucHdl = (docStrucHandle) (GetWRefCon(windowRef));	if(controlRef == (*docStrucHdl)->popupTimeZoneRef) 	{		TrackControl(controlRef,mouseLocation,(ControlActionUPP) -1);		controlValue = GetControlValue(controlRef);		doPopupMenuChoice(windowRef,controlRef,controlValue);	}	else if(controlRef == (*docStrucHdl)->scrollbarVertRef) 	{		doVertScrollbar(controlPartCode,windowRef,controlRef,mouseLocation);	}	else if(controlRef == (*docStrucHdl)->scrollbarHorizRef)	{		TrackControl(controlRef,mouseLocation,gActionFunctionHorizUPP);	}	else	{		if(TrackControl(controlRef,mouseLocation,NULL))		{			if(controlRef == (*docStrucHdl)->radiobuttonRedRef ||				 controlRef == (*docStrucHdl)->radiobuttonWhiteRef ||				 controlRef == (*docStrucHdl)->radiobuttonBlueRef)			{				doRadioButtons(controlRef,windowRef);			}			if(controlRef == (*docStrucHdl)->buttonRef ||				 controlRef == (*docStrucHdl)->buttonDefaultRef)			{				doPushButtons(controlRef,windowRef);			}		}	}}// ***************************************************************************** doControlHit2void  doControlHit2(void){	docStrucHandle	docStrucHdl;	ControlRef			controlRef;	SInt16					controlValue;		docStrucHdl = (docStrucHandle) GetWRefCon(FrontWindow());	controlRef = (*docStrucHdl)->popupCountryRef;	controlValue = GetControlValue(controlRef);	doPopupMenuChoice(FrontWindow(),controlRef,controlValue);}// ************************************************************************* doPopupMenuChoicevoid  doPopupMenuChoice(WindowRef windowRef,ControlRef controlRef,SInt16 controlValue){	MenuRef	menuRef;	Size		actualSize;	GetControlData(controlRef,kControlEntireControl,kControlPopupButtonMenuHandleTag,								 sizeof(menuRef),&menuRef,&actualSize);	GetMenuItemText(menuRef,controlValue,gCurrentString);			doDrawMessage(windowRef,true);}// *************************************************************************** doVertScrollbarvoid  doVertScrollbar(ControlPartCode controlPartCode,WindowRef windowRef,											ControlRef controlRef,Point mouseXY){	Str255	valueString;	doCopyPString("\pScroll Bar Control Value: ",gCurrentString);	switch(controlPartCode)	{		case kControlIndicatorPart:			if(TrackControl(controlRef,mouseXY,NULL))			{				NumToString((SInt32) GetControlValue(controlRef),valueString);				doConcatPStrings(gCurrentString,valueString);				doDrawMessage(windowRef,true);			}			break;		case kControlUpButtonPart:		case kControlDownButtonPart:		case kControlPageUpPart:		case kControlPageDownPart:			TrackControl(controlRef,mouseXY,gActionFunctionVertUPP);			break;	}}// ************************************************************************ actionFunctionVertvoid  actionFunctionVert(ControlRef controlRef,ControlPartCode controlPartCode){	SInt16		scrollDistance, controlValue;	Str255		valueString;	WindowRef	windowRef;	doCopyPString("\pScroll Bar Control Value: ",gCurrentString);	if(controlPartCode)	{		switch(controlPartCode)		{			case kControlUpButtonPart:			case kControlDownButtonPart:				scrollDistance = 2;				break;			case kControlPageUpPart:			case kControlPageDownPart:				scrollDistance = 55;				break;		}		if((controlPartCode == kControlDownButtonPart) || 			 (controlPartCode == kControlPageDownPart))			scrollDistance = -scrollDistance;		controlValue = GetControlValue(controlRef);		if(((controlValue == GetControlMaximum(controlRef)) && scrollDistance < 0) || 			 ((controlValue == GetControlMinimum(controlRef)) && scrollDistance > 0))			return;		doMoveScrollBox(controlRef,scrollDistance);		NumToString((SInt32) GetControlValue(controlRef),valueString);		doConcatPStrings(gCurrentString,valueString);		windowRef = GetControlOwner(controlRef);		doDrawMessage(windowRef,true);	}}// *********************************************************************** actionFunctionHorizvoid  actionFunctionHoriz(ControlRef controlRef,ControlPartCode controlPartCode){	SInt16		scrollDistance, controlValue;	Str255		valueString;	WindowRef	windowRef;	doCopyPString("\pScroll Bar Control Value: ",gCurrentString);	if(controlPartCode != kControlIndicatorPart)	{		switch(controlPartCode)		{			case kControlUpButtonPart:			case kControlDownButtonPart:				scrollDistance = 2;				break;			case kControlPageUpPart:			case kControlPageDownPart:				scrollDistance = 55;				break;		}		if((controlPartCode == kControlDownButtonPart) || 			 (controlPartCode == kControlPageDownPart))			scrollDistance = -scrollDistance;		controlValue = GetControlValue(controlRef);		if(((controlValue == GetControlMaximum(controlRef)) && scrollDistance < 0) || 			 ((controlValue == GetControlMinimum(controlRef)) && scrollDistance > 0))			return;		doMoveScrollBox(controlRef,scrollDistance);	}	NumToString((SInt32) GetControlValue(controlRef),valueString);	doConcatPStrings(gCurrentString,valueString);	windowRef = GetControlOwner(controlRef);	doDrawMessage(windowRef,true);}// *************************************************************************** doMoveScrollBoxvoid doMoveScrollBox(ControlRef controlRef,SInt16 scrollDistance){	SInt16	oldControlValue, controlValue, controlMax;	oldControlValue = GetControlValue(controlRef);	controlMax = GetControlMaximum(controlRef);	controlValue = oldControlValue - scrollDistance;	if(controlValue < 0)		controlValue = 0;	else if(controlValue > controlMax)		controlValue = controlMax;	SetControlValue(controlRef,controlValue);}// **************************************************************************** doRadioButtonsvoid  doRadioButtons(ControlRef controlRef,WindowRef windowRef){		docStrucHandle	docStrucHdl;	docStrucHdl = (docStrucHandle) (GetWRefCon(windowRef));	SetControlValue((*docStrucHdl)->radiobuttonRedRef,kControlRadioButtonUncheckedValue);	SetControlValue((*docStrucHdl)->radiobuttonWhiteRef,kControlRadioButtonUncheckedValue);	SetControlValue((*docStrucHdl)->radiobuttonBlueRef,kControlRadioButtonUncheckedValue);	SetControlValue(controlRef,kControlRadioButtonCheckedValue);}// ****************************************************************************** doCheckboxesvoid  doCheckboxes(ControlRef controlRef){	SetControlValue(controlRef,!GetControlValue(controlRef));}// ***************************************************************************** doPushButtonsvoid  doPushButtons(ControlRef controlRef,WindowRef windowRef){	docStrucHandle	docStrucHdl;	docStrucHdl = (docStrucHandle) (GetWRefCon(windowRef));	if(controlRef == (*docStrucHdl)->buttonRef)	{		doCopyPString("\pCancel button",gCurrentString);		doDrawMessage(windowRef,true);	}	else if(controlRef == (*docStrucHdl)->buttonDefaultRef)	{		doCopyPString("\pDefault button",gCurrentString);		doDrawMessage(windowRef,true);	}}// ************************************************************************ doAdjustScrollBarsvoid	doAdjustScrollBars(WindowRef windowRef){	Rect						portRect;	docStrucHandle	docStrucHdl;	docStrucHdl = (docStrucHandle) (GetWRefCon(windowRef));	GetWindowPortBounds(windowRef,&portRect);	HideControl((*docStrucHdl)->scrollbarVertRef);	HideControl((*docStrucHdl)->scrollbarHorizRef);	MoveControl((*docStrucHdl)->scrollbarVertRef,portRect.right - kScrollBarWidth,							portRect.top + 25);	MoveControl((*docStrucHdl)->scrollbarHorizRef,portRect.left -1,							portRect.bottom - kScrollBarWidth);	SizeControl((*docStrucHdl)->scrollbarVertRef,16, portRect.bottom - 39);	SizeControl((*docStrucHdl)->scrollbarHorizRef, portRect.right - 13,16);	ShowControl((*docStrucHdl)->scrollbarVertRef);	ShowControl((*docStrucHdl)->scrollbarHorizRef);		SetControlMaximum((*docStrucHdl)->scrollbarVertRef,portRect.bottom - portRect.top - 25										- kScrollBarWidth);	SetControlMaximum((*docStrucHdl)->scrollbarHorizRef,portRect.right - portRect.left 										- kScrollBarWidth);}// **************************************************************************** doAdjustCursorvoid  doAdjustCursor(WindowRef windowRef){	RgnHandle		myArrowRegion;	RgnHandle		myIBeamRegion;	Rect				cursorRect;	Point				mousePt;	ControlRef	controlRef;	Cursor			arrow;	myArrowRegion = NewRgn();	myIBeamRegion = NewRgn();		SetRectRgn(myArrowRegion,-32768,-32768,32767,32767);	SetRect(&cursorRect,24,250,254,269);	SetPortWindowPort(windowRef);	LocalToGlobal(&topLeft(cursorRect));	LocalToGlobal(&botRight(cursorRect));		RectRgn(myIBeamRegion,&cursorRect);	DiffRgn(myArrowRegion,myIBeamRegion,myArrowRegion);	GetGlobalMouse(&mousePt);	GetKeyboardFocus(FrontWindow(),&controlRef);	if(PtInRgn(mousePt,myIBeamRegion) && controlRef)		SetCursor(*(GetCursor(iBeamCursor)));	else		SetCursor(GetQDGlobalsArrow(&arrow));	DisposeRgn(myArrowRegion);	DisposeRgn(myIBeamRegion);}// ********************************************************************** doDrawDocumentTypingvoid  doDrawDocumentTyping(SInt8 charCode,UInt32 modifiers){	Rect				typingRect	= { 118,128,194,253 };	Rect				shiftRect		= { 131,181,139,189 };	Rect				controlRect	= { 144,181,152,189 };	Rect				optionRect	= { 157,181,165,189 };	Rect				cmdRect			= { 170,181,178,189 };	Rect				textBoxRect;	CFStringRef	stringRef;	EraseRect(&typingRect);	stringRef = CFStringCreateWithPascalString(NULL,"\pShift",kCFStringEncodingMacRoman);	SetRect(&textBoxRect,142,132,242,147);	if((modifiers & shiftKey) != 0)	TextMode(srcOr); else TextMode(grayishTextOr);	DrawThemeTextBox(stringRef,kThemeSmallSystemFont,0,false,&textBoxRect,teJustLeft,NULL);	stringRef = CFStringCreateWithPascalString(NULL,"\pControl",kCFStringEncodingMacRoman);	SetRect(&textBoxRect,142,145,242,160);	if((modifiers & controlKey) != 0)	TextMode(srcOr); else TextMode(grayishTextOr);	DrawThemeTextBox(stringRef,kThemeSmallSystemFont,0,false,&textBoxRect,teJustLeft,NULL);	stringRef = CFStringCreateWithPascalString(NULL,"\pOption",kCFStringEncodingMacRoman);	SetRect(&textBoxRect,142,158,242,173);	if((modifiers & optionKey) != 0)	TextMode(srcOr); else TextMode(grayishTextOr);	DrawThemeTextBox(stringRef,kThemeSmallSystemFont,0,false,&textBoxRect,teJustLeft,NULL);	stringRef = CFStringCreateWithPascalString(NULL,"\pCmd",kCFStringEncodingMacRoman);	SetRect(&textBoxRect,142,171,242,186);	if((modifiers & cmdKey) != 0)	TextMode(srcOr); else TextMode(grayishTextOr);	DrawThemeTextBox(stringRef,kThemeSmallSystemFont,0,false,&textBoxRect,teJustLeft,NULL);	if(stringRef != NULL)				CFRelease(stringRef);	TextMode(srcOr);	MoveTo(205,171);	DrawChar(charCode);		}// ***************************************************************************** doDrawMessagevoid  doDrawMessage(WindowRef windowRef,Boolean inState){	Rect				portRect, headerRect, textBoxRect;	CFStringRef	stringRef;	SetPortWindowPort(windowRef);	GetWindowPortBounds(windowRef,&portRect);	SetRect(&headerRect,portRect.left - 1,portRect.top - 1,portRect.right + 1,	        portRect.top + 26);	DrawThemeWindowHeader(&headerRect,inState);	stringRef = CFStringCreateWithPascalString(NULL,gCurrentString,																								 kCFStringEncodingMacRoman);	SetRect(&textBoxRect,portRect.left,5,portRect.right,25);	if(inState == kThemeStateActive)		TextMode(srcOr);	else	  TextMode(grayishTextOr);	DrawThemeTextBox(stringRef,kThemeSmallSystemFont,inState,false,&textBoxRect,teJustCenter,										 NULL);	if(stringRef != NULL)				CFRelease(stringRef);}// ************************************************************************** doConcatPStringsvoid  doConcatPStrings(Str255 targetString,Str255 appendString){	SInt16	appendLength;	appendLength = MIN(appendString[0],255 - targetString[0]);	if(appendLength > 0)	{		BlockMoveData(appendString+1,targetString+targetString[0]+1,(SInt32) appendLength);		targetString[0] += appendLength;	}}// ***************************************************************************** doCopyPStringvoid  doCopyPString(Str255 sourceString,Str255 destinationString){	SInt16	stringLength;	stringLength = sourceString[0];	BlockMove(sourceString + 1,destinationString + 1,stringLength);	destinationString[0] = stringLength;}// *******************************************************************************************