// *******************************************************************************************// MoreResources.c                                                          CARBON EVENT MODEL// *******************************************************************************************// // This program uses custom resources to://// ╔	Store application preferences in the resource fork of a Preferences file.//// ╔	Store, in the resource fork of a document file:////		╔  The size and position of the window associated with the document.////		╔  A flattened PMPageFormat object containing information about how the pages of the//			 document should be printed, for example, on what paper size, in what printable//			 area, and in what orientation (landscape or portrait). //// The program also demonstrates setting, storing, and retrieving application preferences // using Core Foundation Preferences Services.//// The program utilises the following standard resources://// ╔	A 'plst' resource.//// ╔	An 'MBAR' resource, and 'MENU' resources for OS9Apple/Applcation, File, Edit and //		Demonstration menus (preload, non-purgeable).  //// ╔	A 'DLOG' resource (purgeable) and associated 'dlgx', 'DITL' and 'CNTL' resources //		(purgeable) associated with the display of, and user modification of, current //		application preferences. //// ╔	A 'STR#' resource (purgeable) containing the required name of the preferences file//		created by the program.//// ╔	A 'STR ' resource (purgeable) containing the application-missing string, which is copied//		to the resource fork of the preferences file.//// ╔	A 'SIZE' resource with the acceptSuspendResumeEvents, canBackground, //		doesActivateOnFGSwitch, and isHighLevelEventAware flags set.//// The program creates and utilises the following custom resources://// ╔	A 'PrFn' (preferences) resource comprising three boolean values, which is located in the//		program's resource file, which contains default preference values, and which is copied //		to the resource fork of a preferences file created when the program is run for the first//		time.  Thereafter, the 'PrFn' resource in the preferences file is used for the storage//		and retrieval of application preferences set by the user.//// ╔	A 'WiSp' (window size and position) resource, which is created in the resource fork of//		the document file used by the program, and which is used to store the associated //		window's port rectangle converted to global coordinates.//// ╔	A 'PgFt' (page format) resource, which is created in the resource fork of the document//		file used by the program, and which is used to store a flattened PMPageFormat object.//// *******************************************************************************************// ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии includes#include <Carbon.h>// иииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии defines#define rMenubar					128#define mAppleApplication	128#define  iAbout						1#define mFile							129#define  iOpen						2#define  iClose						4#define  iPageSetup				9#define  iQuit						12#define mEdit							130#define  iPreferences			10#define rPrefsDialog			128#define  iSound						4	#define  iFullScreen			5#define  iAutoScroll			6#define rStringList				128#define  iPrefsFileName		1#define rTypePrefs				'PrFn'#define  kPrefsID					128#define rTypeWinSizePos		'WiSp'#define  kWinSizePosID		128#define rPageFormat				'PgFt'#define  kPageFormatID		128#define rTypeAppMiss			'STR '#define  kAppMissID				-16397#define topLeft(r)				(((Point *) &(r))[0])#define botRight(r)				(((Point *) &(r))[1])// ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии typedefstypedef struct{	Boolean	sound;	Boolean	fullScreen;	Boolean	autoScroll;	SInt16	programRunCount;} appPrefs, **appPrefsHandle;typedef struct{	Rect windowRect;} windowSizePos, **windowSizePosHandle;typedef struct{	Handle	pageFormatHdl;	FSSpec	fileFSSpec;} docStructure, **docStructureHandle;// ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии global variablesBoolean					gRunningOnX = false;PMPrintSession	gPrintSession;WindowRef				gWindowRef;SInt16					gAppResFileRefNum;Boolean					gSoundPref;Boolean					gFullScreenPref;Boolean					gAutoScrollPref;	SInt16					gProgramRunCountPref;Boolean					gSoundCFPref;Boolean					gFullScreenCFPref;Boolean					gAutoScrollCFPref;SInt16					gProgramRunCountCFPref;Boolean					gWindowOpen					= false;Boolean					gPageFormatChanged	= false;SInt16					gPrefsFileRefNum		= 0;// иииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии function prototypesvoid			main															(void);void			doPreliminaries										(void);OSStatus	appEventHandler										(EventHandlerCallRef,EventRef,void *);OSStatus	windowEventHandler								(EventHandlerCallRef,EventRef,void *);void			doDrawContent											(WindowRef);void			doAdjustMenus											(void);void			doMenuChoice											(MenuID,MenuItemIndex);void			doErrorAlert											(SInt16);void			doOpenCommand											(void);void			navEventFunction									(NavEventCallbackMessage,NavCBRecPtr,																						 NavCallBackUserData);void			doOpenWindow											(FSSpec);void			doCloseWindow											(void);void			doPreferencesDialog								(void);OSStatus	doPageSetupDialog									(void);void			doGetPreferencesResource					(void);void			doGetPreferencesCFPrefs						(void);OSErr			doCopyResource										(ResType,SInt16,SInt16,SInt16);void			doSavePreferencesResource					(void);void			doSavePreferencesCFPrefs					(void);void			doLoadAndSetWindowSizeAndPosition	(WindowRef);void			doGetFrameWidthAndTitleBarHeight	(WindowRef,SInt16 *,SInt16 *);void			doSaveWindowSizeAndPosition				(WindowRef);void			doGetPageFormat										(WindowRef);void			doSavePageFormat									(WindowRef);// ************************************************************************************** mainvoid  main(void){	MenuBarHandle	menubarHdl;	SInt32				response;	MenuRef				menuRef;	OSStatus			osStatus;	EventTypeSpec	applicationEvents[] =	{	{ kEventClassCommand, kEventProcessCommand  },																				{ kEventClassMenu,    kEventMenuEnableItems } };	// ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии do preliminaries	doPreliminaries();	// ииииииииииииииииииииииииииииииииии set current resource file to application resource fork	gAppResFileRefNum = CurResFile();	// иииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии set up menu bar and menus	menubarHdl = GetNewMBar(rMenubar);	if(menubarHdl == NULL)		doErrorAlert(MemError());	SetMenuBar(menubarHdl);	DrawMenuBar();	Gestalt(gestaltMenuMgrAttr,&response);	if(response & gestaltMenuMgrAquaLayoutMask)	{		menuRef = GetMenuRef(mFile);		if(menuRef != NULL)		{			DeleteMenuItem(menuRef,iQuit);			DeleteMenuItem(menuRef,iQuit - 1);		}		menuRef = GetMenuRef(mEdit);		if(menuRef != NULL)		{			DeleteMenuItem(menuRef,iPreferences);			DeleteMenuItem(menuRef,iPreferences - 1);			DisableMenuItem(menuRef,0);		}			EnableMenuCommand(NULL,kHICommandPreferences);		gRunningOnX = true;	}	else	{		menuRef = GetMenuRef(mFile);		if(menuRef != NULL)			SetMenuItemCommandID(menuRef,iQuit,kHICommandQuit);		menuRef = GetMenuRef(mEdit);		if(menuRef != NULL)			SetMenuItemCommandID(menuRef,iPreferences,kHICommandPreferences);	}	// иииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии create printing session	osStatus = PMCreateSession(&gPrintSession);	if(osStatus != kPMNoError)		doErrorAlert(osStatus);	// иииииииииииииииииииииииии read in application preferences and increment program run count	doGetPreferencesResource();	doGetPreferencesCFPrefs();	gProgramRunCountPref++;	gProgramRunCountCFPref++;	// иииииииииииииииииииииииииииииииииииииииииииииииииииииии install application event handler  	InstallApplicationEventHandler(NewEventHandlerUPP((EventHandlerProcPtr) appEventHandler),																 GetEventTypeCount(applicationEvents),applicationEvents,																 0,NULL);	// ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии run application event loop	RunApplicationEventLoop();}// *************************************************************************** doPreliminariesvoid  doPreliminaries(void){	MoreMasterPointers(320);	InitCursor();}// *************************************************************************** appEventHandlerOSStatus  appEventHandler(EventHandlerCallRef eventHandlerCallRef,EventRef eventRef,													void * userData){	OSStatus			result = eventNotHandledErr;	UInt32				eventClass;	UInt32				eventKind;	HICommand			hiCommand;	MenuID				menuID;	MenuItemIndex	menuItem;	eventClass = GetEventClass(eventRef);	eventKind  = GetEventKind(eventRef);	switch(eventClass)	{		case kEventClassCommand:			if(eventKind == kEventProcessCommand)			{				GetEventParameter(eventRef,kEventParamDirectObject,typeHICommand,NULL,													sizeof(HICommand),NULL,&hiCommand);				menuID = GetMenuID(hiCommand.menu.menuRef);				menuItem = hiCommand.menu.menuItemIndex;				if(hiCommand.commandID == kHICommandPreferences)				{					doPreferencesDialog();					result = noErr;				}				else if(hiCommand.commandID == kHICommandQuit)				{					while(FrontWindow())						doCloseWindow();					PMRelease(&gPrintSession);					doSavePreferencesResource();					doSavePreferencesCFPrefs();				}				else if((menuID >= mAppleApplication && menuID <= mEdit))				{					doMenuChoice(menuID,menuItem);					result = noErr;				}			}			break;		case kEventClassMenu:			if(eventKind == kEventMenuEnableItems)			{				doAdjustMenus();				result = noErr;			}			break;	}	return result;}// ************************************************************************ windowEventHandlerOSStatus  windowEventHandler(EventHandlerCallRef eventHandlerCallRef,EventRef eventRef,														 void* userData){	OSStatus	result = eventNotHandledErr;	UInt32		eventClass;	UInt32		eventKind;	WindowRef	windowRef;	Rect			mainScreenRect;	BitMap		screenBits;	Point			idealHeightAndWidth, minimumHeightAndWidth;		eventClass = GetEventClass(eventRef);	eventKind  = GetEventKind(eventRef);	switch(eventClass)	{		case kEventClassWindow:			GetEventParameter(eventRef,kEventParamDirectObject,typeWindowRef,NULL,sizeof(windowRef),										NULL,&windowRef);			switch(eventKind)			{				case kEventWindowDrawContent:					doDrawContent(windowRef);					result = noErr;					break;				case kEventWindowGetIdealSize:					mainScreenRect = GetQDGlobalsScreenBits(&screenBits)->bounds;					idealHeightAndWidth.v = mainScreenRect.bottom - 75;					idealHeightAndWidth.h = 600;					SetEventParameter(eventRef,kEventParamDimensions,typeQDPoint,														sizeof(idealHeightAndWidth),&idealHeightAndWidth); 					result = noErr;					break;				case kEventWindowGetMinimumSize:					minimumHeightAndWidth.v = 190; 					minimumHeightAndWidth.h = 400;					SetEventParameter(eventRef,kEventParamDimensions,typeQDPoint,														sizeof(minimumHeightAndWidth),&minimumHeightAndWidth);					result = noErr;					break;				case kEventWindowClose:					doCloseWindow();					result = noErr;					break;			}			break;	}	return result;}// ***************************************************************************** doDrawContentvoid  doDrawContent(WindowRef windowRef){	RGBColor						whiteColour	= { 0xFFFF, 0xFFFF, 0xFFFF };	RGBColor						blueColour	= { 0x1818, 0x4B4B, 0x8181 };	Rect								portRect;	docStructureHandle	docStrucHdl;	PMPageFormat				pageFormat	= kPMNoPageFormat;	Str255							string;	PMResolution				resolution;	PMRect							paperRect;	PMRect							pageRect;	UInt16							orientation;	RGBForeColor(&whiteColour);	RGBBackColor(&blueColour);	GetWindowPortBounds(windowRef,&portRect);	EraseRect(&portRect);		SetPortWindowPort(windowRef);	MoveTo(10,20);	TextFace(bold);	DrawString("\pApplication Preferences:");	MoveTo(10,35);	DrawString("\pResource Fork Prefs File");	MoveTo(170,35);	DrawString("\pCF Preferences Services");	TextFace(normal);	MoveTo(10,50);	DrawString("\pSound On:  ");	if(gSoundPref)  DrawString("\pYES");	else  DrawString("\pNO");	MoveTo(10,65);	DrawString("\pFull Screen On:  ");	if(gFullScreenPref)  DrawString("\pYES");	else  DrawString("\pNO");	MoveTo(10,80);	DrawString("\pAutoScroll On:  ");	if(gAutoScrollPref)  DrawString("\pYES");	else  DrawString("\pNO");	MoveTo(10,95);	DrawString("\pProgram run count: ");	NumToString((SInt32) gProgramRunCountPref,string);	DrawString(string);	MoveTo(170,50);	DrawString("\pSound On:  ");	if(gSoundCFPref)  DrawString("\pYES");	else  DrawString("\pNO");	MoveTo(170,65);	DrawString("\pFull Screen On:  ");	if(gFullScreenCFPref)  DrawString("\pYES");	else  DrawString("\pNO");	MoveTo(170,80);	DrawString("\pAutoScroll On:  ");	if(gAutoScrollCFPref)  DrawString("\pYES");	else  DrawString("\pNO");	MoveTo(170,95);	DrawString("\pProgram run count: ");	NumToString((SInt32) gProgramRunCountCFPref,string);	DrawString(string);	docStrucHdl = (docStructureHandle) GetWRefCon(windowRef);	PMUnflattenPageFormat((*docStrucHdl)->pageFormatHdl,&pageFormat);	PMGetResolution(pageFormat,&resolution);	PMGetAdjustedPaperRect(pageFormat,&paperRect);	PMGetAdjustedPageRect(pageFormat,&pageRect);	PMGetOrientation(pageFormat,&orientation);	if(pageFormat != kPMNoPageFormat)		PMRelease(&pageFormat);	MoveTo(10,115);	TextFace(bold);	DrawString("\pInformation From Document's 'PgFt' (Page Format) Resource:"); 	TextFace(normal);	if((*docStrucHdl)->pageFormatHdl != NULL)	{		MoveTo(10,130);		DrawString("\pApplication's Drawing Resolution:  ");		NumToString((long) resolution.hRes,string);		DrawString(string);		DrawString("\p dpi horizontal, ");		NumToString((long) resolution.vRes,string);		DrawString(string);		DrawString("\p dpi vertical");				MoveTo(10,145);		DrawString("\pPaper Rectangle Size in Drawing Resolution:  ");		NumToString((long) (paperRect.bottom - paperRect.top),string);		DrawString(string);		DrawString("\p by ");		NumToString((long) (paperRect.right - paperRect.left),string);		DrawString(string);		MoveTo(10,160);		DrawString("\pPage Rectangle Size in Drawing Resolution:  ");		NumToString((long) (pageRect.bottom - pageRect.top),string);		DrawString(string);		DrawString("\p by ");		NumToString((long) (pageRect.right - pageRect.left),string);		DrawString(string);		MoveTo(10,175);		DrawString("\pOrientation:  ");		if(orientation == 1)			DrawString("\pPortrait");		else if(orientation == 2)			DrawString("\pLandscape");	}	else	{		MoveTo(10,130);		DrawString("\pA page format ('PgFt') resource has not been saved yet."); 		MoveTo(10,145);		DrawString("\pOpen the Page Setup... dialog before closing the window or quitting."); 	}	QDFlushPortBuffer(GetWindowPort(gWindowRef),NULL);}// ***************************************************************************** doAdjustMenusvoid  doAdjustMenus(void){	MenuRef	menuRef;	if(gWindowOpen)	{		menuRef = GetMenuRef(mFile);		DisableMenuItem(menuRef,iOpen);		EnableMenuItem(menuRef,iClose);		EnableMenuItem(menuRef,iPageSetup);	}	else	{		menuRef = GetMenuRef(mFile);		EnableMenuItem(menuRef,iOpen);		DisableMenuItem(menuRef,iClose);		DisableMenuItem(menuRef,iPageSetup);	}	DrawMenuBar();}// ****************************************************************************** doMenuChoicevoid  doMenuChoice(MenuID menuID,MenuItemIndex menuItem){	OSStatus	osStatus;	Rect			portRect;	if(menuID == 0)		return;	switch(menuID)	{		case mAppleApplication:			if(menuItem == iAbout)				SysBeep(10);			break;		case mFile:			switch(menuItem)			{				case iClose:					doCloseWindow();					break;				case iOpen:					doOpenCommand();					break;				case iPageSetup:					osStatus = doPageSetupDialog();					if(osStatus != kPMNoError && osStatus != kPMCancel)						doErrorAlert(osStatus);					if(FrontWindow())					{						GetWindowPortBounds(FrontWindow(),&portRect);						InvalWindowRect(FrontWindow(),&portRect);					}					break;			}			break;	}}// ****************************************************************************** doErrorAlertvoid  doErrorAlert(SInt16 errorCode){	Str255	errorString;	SInt16	itemHit;	NumToString((SInt32) errorCode,errorString);	if(errorCode != memFullErr)		StandardAlert(kAlertCautionAlert,errorString,NULL,NULL,&itemHit);	else	{		StandardAlert(kAlertStopAlert,errorString,NULL,NULL,&itemHit);		ExitToShell();	}}// ***************************************************************************** doOpenCommandvoid  doOpenCommand(void){	OSErr							osError = noErr;	NavDialogOptions	dialogOptions;	NavEventUPP				navEventFunctionUPP;		NavReplyRecord		navReplyStruc;	SInt32						index, count;	AEKeyword					theKeyword;	DescType					actualType;	FSSpec						fileSpec;		Size							actualSize;	osError = NavGetDefaultDialogOptions(&dialogOptions);	if(osError == noErr)	{		navEventFunctionUPP = NewNavEventUPP((NavEventProcPtr) navEventFunction);		osError = NavGetFile(NULL,&navReplyStruc,&dialogOptions,navEventFunctionUPP,NULL,NULL,												 NULL,NULL);		DisposeNavEventUPP(navEventFunctionUPP);		if(osError == noErr && navReplyStruc.validRecord)		{			osError = AECountItems(&(navReplyStruc.selection),&count);			if(osError == noErr)			{				for(index=1;index<=count;index++)				{					osError = AEGetNthPtr(&(navReplyStruc.selection),index,typeFSS,&theKeyword,																&actualType,&fileSpec,sizeof(fileSpec),&actualSize);					doOpenWindow(fileSpec);				}			}			NavDisposeReply(&navReplyStruc);			}	}}// ************************************************************************** navEventFunctionvoid  navEventFunction(NavEventCallbackMessage callBackSelector,NavCBRecPtr callBackParms,											 NavCallBackUserData callBackUD){}// ****************************************************************************** doOpenWindowvoid  doOpenWindow(FSSpec fileSpec){	OSStatus						osError;	docStructureHandle	docStrucHdl;	Rect								contentRect = { 100,100,290,500 };	WindowAttributes		attributes	= { kWindowStandardHandlerAttribute |																			kWindowStandardDocumentAttributes };	EventTypeSpec				windowEvents[] = { { kEventClassWindow, kEventWindowDrawContent    },																				 { kEventClassWindow, kEventWindowGetIdealSize   },																				 { kEventClassWindow, kEventWindowGetMinimumSize },																				 { kEventClassWindow, kEventWindowClose          } };	osError = CreateNewWindow(kDocumentWindowClass,attributes,&contentRect,&gWindowRef);	if(osError != noErr)		QuitApplicationEventLoop();	if(!(docStrucHdl = (docStructureHandle) NewHandle(sizeof(docStructure))))	{		DisposeWindow(gWindowRef);		QuitApplicationEventLoop();	}	SetWRefCon(gWindowRef,(SInt32) docStrucHdl);	(*docStrucHdl)->fileFSSpec = fileSpec;	SetWTitle(gWindowRef,(*docStrucHdl)->fileFSSpec.name);		(*docStrucHdl)->pageFormatHdl = NULL;	SetPortWindowPort(gWindowRef);	UseThemeFont(kThemeSmallSystemFont,smSystemScript);	InstallWindowEventHandler(gWindowRef,														NewEventHandlerUPP((EventHandlerProcPtr) windowEventHandler),														GetEventTypeCount(windowEvents),windowEvents,0,NULL);						doLoadAndSetWindowSizeAndPosition(gWindowRef);	doGetPageFormat(gWindowRef);	ShowWindow(gWindowRef);	gWindowOpen = true; }// ***************************************************************************** doCloseWindowvoid  doCloseWindow(void){	WindowRef						windowRef;	docStructureHandle	docStrucHdl;	OSErr								osError = 0;	windowRef = FrontWindow();	docStrucHdl = (docStructureHandle) GetWRefCon(windowRef);	doSaveWindowSizeAndPosition(windowRef);	if(gPageFormatChanged)		doSavePageFormat(windowRef);	DisposeHandle((Handle) docStrucHdl);	DisposeWindow(windowRef);	gWindowOpen = false;}// *********************************************************************** doPreferencesDialogvoid  doPreferencesDialog(void){	DialogRef 	modalDlgRef;	ControlRef	controlHdl;	SInt16 			itemHit;	Rect				portRect;	if(!(modalDlgRef = GetNewDialog(rPrefsDialog,NULL,(WindowRef) -1)))		return;	SetDialogDefaultItem(modalDlgRef,kStdOkItemIndex);	SetDialogCancelItem(modalDlgRef,kStdCancelItemIndex);	GetDialogItemAsControl(modalDlgRef,iSound,&controlHdl);	SetControlValue(controlHdl,gSoundPref);	GetDialogItemAsControl(modalDlgRef,iFullScreen,&controlHdl);	SetControlValue(controlHdl,gFullScreenPref);	GetDialogItemAsControl(modalDlgRef,iAutoScroll,&controlHdl);	SetControlValue(controlHdl,gAutoScrollPref);	ShowWindow(GetDialogWindow(modalDlgRef));	do	{		ModalDialog(NULL,&itemHit);		GetDialogItemAsControl(modalDlgRef,itemHit,&controlHdl);		SetControlValue(controlHdl,!GetControlValue(controlHdl));	} while((itemHit != kStdOkItemIndex) && (itemHit != kStdCancelItemIndex));		if(itemHit == kStdOkItemIndex)	{		GetDialogItemAsControl(modalDlgRef,iSound,&controlHdl);		gSoundPref = gSoundCFPref = GetControlValue(controlHdl);		GetDialogItemAsControl(modalDlgRef,iFullScreen,&controlHdl);		gFullScreenPref = gFullScreenCFPref = GetControlValue(controlHdl);		GetDialogItemAsControl(modalDlgRef,iAutoScroll,&controlHdl);		gAutoScrollPref = gAutoScrollCFPref = GetControlValue(controlHdl);					}	DisposeDialog(modalDlgRef);	if(gWindowRef)	{		GetWindowPortBounds(gWindowRef,&portRect);		InvalWindowRect(gWindowRef,&portRect);	}	doSavePreferencesResource();	doSavePreferencesCFPrefs();}// ************************************************************************* doPageSetupDialogOSStatus  doPageSetupDialog(void){	docStructureHandle	docStrucHdl;	OSStatus						osStatus		= kPMNoError;	PMPageFormat				pageFormat	= kPMNoPageFormat;	Boolean							userClickedOKButton;	docStrucHdl = (docStructureHandle) GetWRefCon(gWindowRef);		HLock((Handle) docStrucHdl);	if((*docStrucHdl)->pageFormatHdl == NULL)	{		osStatus = PMCreatePageFormat(&pageFormat);		if((osStatus == kPMNoError) && (pageFormat != kPMNoPageFormat))			osStatus = PMSessionDefaultPageFormat(gPrintSession,pageFormat);		if(osStatus == kPMNoError)			osStatus = PMFlattenPageFormat(pageFormat,&(*docStrucHdl)->pageFormatHdl);	}	else	{		osStatus = PMUnflattenPageFormat((*docStrucHdl)->pageFormatHdl,&pageFormat);		if(osStatus == kPMNoError)			osStatus = PMSessionValidatePageFormat(gPrintSession,pageFormat,kPMDontWantBoolean);	}	if((osStatus == kPMNoError) && (pageFormat != kPMNoPageFormat))	{		SetThemeCursor(kThemeArrowCursor);		osStatus = PMSessionPageSetupDialog(gPrintSession,pageFormat,&userClickedOKButton);		if(!userClickedOKButton)			osStatus = kPMCancel;	}	if(osStatus == kPMNoError && userClickedOKButton)	{		DisposeHandle((*docStrucHdl)->pageFormatHdl);		(*docStrucHdl)->pageFormatHdl = NULL;		osStatus = PMFlattenPageFormat(pageFormat,&(*docStrucHdl)->pageFormatHdl);		gPageFormatChanged = true;	}	if(pageFormat != kPMNoPageFormat)		PMRelease(&pageFormat);	HUnlock((Handle) docStrucHdl);	return osStatus;}// ****************************************************************** doGetPreferencesResourcevoid  doGetPreferencesResource(void){	Str255					prefsFileName;	OSErr						osError;	SInt16					volRefNum;	long						directoryID;	FSSpec 					fileSSpec;	SInt16					fileRefNum;	appPrefsHandle	appPrefsHdl;	GetIndString(prefsFileName,rStringList,iPrefsFileName);	osError = FindFolder(kUserDomain,kPreferencesFolderType,kDontCreateFolder,&volRefNum,											 &directoryID);	if(osError == noErr)		osError = FSMakeFSSpec(volRefNum,directoryID,prefsFileName,&fileSSpec);	if(osError == noErr || osError == fnfErr)		fileRefNum = FSpOpenResFile(&fileSSpec,fsCurPerm);	if(fileRefNum == -1)	{		FSpCreateResFile(&fileSSpec,'PpPp','pref',smSystemScript);		osError = ResError();		if(osError == noErr)		{			fileRefNum = FSpOpenResFile(&fileSSpec,fsCurPerm);			if(fileRefNum != -1 )			{				UseResFile(gAppResFileRefNum);									osError = doCopyResource(rTypePrefs,kPrefsID,gAppResFileRefNum,fileRefNum);				if(osError == noErr)					osError = doCopyResource(rTypeAppMiss,kAppMissID,gAppResFileRefNum,fileRefNum);				if(osError != noErr)				{					CloseResFile(fileRefNum);					osError = FSpDelete(&fileSSpec);					fileRefNum = -1;				}			}		}	}	if(fileRefNum != -1)	{		UseResFile(fileRefNum); 		appPrefsHdl = (appPrefsHandle) Get1Resource(rTypePrefs,kPrefsID);		if(appPrefsHdl == NULL)			return;		gSoundPref = (*appPrefsHdl)->sound;		gFullScreenPref = (*appPrefsHdl)->fullScreen;		gAutoScrollPref = (*appPrefsHdl)->autoScroll;		gProgramRunCountPref = (*appPrefsHdl)->programRunCount;				gPrefsFileRefNum = fileRefNum;		UseResFile(gAppResFileRefNum);	}}// ******************************************************************* doGetPreferencesCFPrefsvoid  doGetPreferencesCFPrefs(void){	CFStringRef	applicationID9 = CFSTR("MoreResources CFPrefs");	CFStringRef	applicationIDX = CFSTR("com.Windmill.MoreResources");	CFStringRef	applicationID;	CFStringRef	soundOnKey		= CFSTR("sound");	CFStringRef	fullScreenKey	= CFSTR("fullScreen");	CFStringRef	autoScrollKey	= CFSTR("autoScroll");	CFStringRef runCountKey		= CFSTR("runCount");	Boolean			booleanValue, success;	if(gRunningOnX)		applicationID = applicationIDX;	else		applicationID = applicationID9;	booleanValue = CFPreferencesGetAppBooleanValue(soundOnKey,applicationID,&success);	if(success)		gSoundCFPref = booleanValue;	else	{		gSoundCFPref 			= true;		gFullScreenCFPref	= true;		gAutoScrollCFPref	= true;		doSavePreferencesCFPrefs();		return;	}	booleanValue = CFPreferencesGetAppBooleanValue(fullScreenKey,applicationID,&success);	if(success)		gFullScreenCFPref = booleanValue;	booleanValue = CFPreferencesGetAppBooleanValue(autoScrollKey,applicationID,&success);	if(success)		gAutoScrollCFPref = booleanValue;	gProgramRunCountCFPref = CFPreferencesGetAppIntegerValue(runCountKey,applicationID,																													 &success);}// **************************************************************************** doCopyResourceOSErr  doCopyResource(ResType resType,SInt16 resID,SInt16 sourceFileRefNum,											SInt16 destFileRefNum){	SInt16	oldResFileRefNum;	Handle	sourceResourceHdl;	ResType	ignoredType;	SInt16	ignoredID;	Str255 	resourceName;	SInt16	resAttributes;	OSErr		osError;	oldResFileRefNum = CurResFile();	UseResFile(sourceFileRefNum);	sourceResourceHdl = Get1Resource(resType,resID);	if(sourceResourceHdl != NULL)	{		GetResInfo(sourceResourceHdl,&ignoredID,&ignoredType,resourceName);		resAttributes = GetResAttrs(sourceResourceHdl);		DetachResource(sourceResourceHdl);		UseResFile(destFileRefNum);		if(ResError() == noErr)			AddResource(sourceResourceHdl,resType,resID,resourceName);		if(ResError() == noErr)			SetResAttrs(sourceResourceHdl,resAttributes);		if(ResError() == noErr)			ChangedResource(sourceResourceHdl);		if(ResError() == noErr)			WriteResource(sourceResourceHdl);	}	osError = ResError();	ReleaseResource(sourceResourceHdl);	UseResFile(oldResFileRefNum);	return osError;}// ***************************************************************** doSavePreferencesResourcevoid  doSavePreferencesResource(void){	SInt16					currentResFile;	appPrefsHandle	appPrefsHdl;	Handle 					existingResHdl;	Str255 					resourceName = "\pPreferences";	if(gPrefsFileRefNum == -1)		return;	currentResFile = CurResFile();	appPrefsHdl = (appPrefsHandle) NewHandleClear(sizeof(appPrefs));	HLock((Handle) appPrefsHdl);	(*appPrefsHdl)->sound = gSoundPref;	(*appPrefsHdl)->fullScreen = gFullScreenPref;	(*appPrefsHdl)->autoScroll = gAutoScrollPref;	(*appPrefsHdl)->programRunCount = gProgramRunCountPref; 			UseResFile(gPrefsFileRefNum);	existingResHdl = Get1Resource(rTypePrefs,kPrefsID);		if(existingResHdl != NULL)	{		RemoveResource(existingResHdl);		DisposeHandle(existingResHdl);		if(ResError() == noErr)			AddResource((Handle) appPrefsHdl,rTypePrefs,kPrefsID,resourceName);		if(ResError() == noErr)			WriteResource((Handle) appPrefsHdl);	}	HUnlock((Handle) appPrefsHdl);	ReleaseResource((Handle) appPrefsHdl);	UseResFile(currentResFile);}// ****************************************************************** doSavePreferencesCFPrefsvoid  doSavePreferencesCFPrefs(void){	CFStringRef	applicationID9 = CFSTR("MoreResources CFPrefs");	CFStringRef	applicationIDX = CFSTR("com.Windmill.MoreResources");	CFStringRef	applicationID;	CFStringRef	soundOnKey		= CFSTR("sound");	CFStringRef	fullScreenKey	= CFSTR("fullScreen");	CFStringRef	autoScrollKey = CFSTR("autoScroll");	CFStringRef	yes						= CFSTR("yes");	CFStringRef	no						= CFSTR("no");	CFStringRef runCountKey		= CFSTR("runCount");	Str255			runCountPascalString;	CFStringRef runCountCFString;	if(gRunningOnX)		applicationID = applicationIDX;	else		applicationID = applicationID9;	if(gSoundCFPref)		CFPreferencesSetAppValue(soundOnKey,yes,applicationID);	else		CFPreferencesSetAppValue(soundOnKey,no,applicationID);			if(gFullScreenCFPref)		CFPreferencesSetAppValue(fullScreenKey,yes,applicationID);	else		CFPreferencesSetAppValue(fullScreenKey,no,applicationID);	if(gAutoScrollCFPref)		CFPreferencesSetAppValue(autoScrollKey,yes,applicationID);	else		CFPreferencesSetAppValue(autoScrollKey,no,applicationID);	NumToString((SInt32) gProgramRunCountCFPref,runCountPascalString);	runCountCFString = CFStringCreateWithPascalString(NULL,runCountPascalString,                                                   		 CFStringGetSystemEncoding());	CFPreferencesSetAppValue(runCountKey,runCountCFString,applicationID);	CFPreferencesAppSynchronize(applicationID);	if(runCountCFString != NULL)		CFRelease(runCountCFString);}// ********************************************************* doLoadAndSetWindowSizeAndPositionvoid  doLoadAndSetWindowSizeAndPosition(WindowRef windowRef){	docStructureHandle	docStrucHdl;	SInt16							fileRefNum;	OSErr								osError;	windowSizePosHandle	windowSizePosHdl;	Rect								windowRect;	SInt16 							frameWidth, titleBarHeight, menuBarHeight;	docStrucHdl = (docStructureHandle) GetWRefCon(windowRef);	fileRefNum = FSpOpenResFile(&(*docStrucHdl)->fileFSSpec,fsRdWrPerm);	if(fileRefNum < 0)	{		osError = ResError();		doErrorAlert(osError);		return;	}	windowSizePosHdl = (windowSizePosHandle) Get1Resource(rTypeWinSizePos,kWinSizePosID);	if(windowSizePosHdl != NULL )	{		windowRect = (*windowSizePosHdl)->windowRect;	}	else	{		doGetFrameWidthAndTitleBarHeight(windowRef,&frameWidth,&titleBarHeight);		GetThemeMenuBarHeight(&menuBarHeight);		SetRect(&windowRect,frameWidth + 1,titleBarHeight + menuBarHeight + 1,						frameWidth + 400,titleBarHeight + menuBarHeight + 190);	}	MoveWindow(windowRef,windowRect.left,windowRect.top,false);	SizeWindow(windowRef,windowRect.right - windowRect.left,windowRect.bottom - windowRect.top,						 true);	ReleaseResource((Handle) windowSizePosHdl);	CloseResFile(fileRefNum);}// ********************************************************** doGetFrameWidthAndTitleBarHeightvoid  doGetFrameWidthAndTitleBarHeight(WindowRef windowRef,SInt16 *frameWidth,																			 SInt16 *titleBarHeight){	RgnHandle	structureRegionHdl	= NewRgn();	RgnHandle	contentRegionHdl		= NewRgn();	Rect			structureRect, contentRect;	GetWindowRegion(windowRef,kWindowStructureRgn,structureRegionHdl);	GetRegionBounds(structureRegionHdl,&structureRect);	GetWindowRegion(windowRef,kWindowContentRgn,contentRegionHdl);	GetRegionBounds(contentRegionHdl,&contentRect);	*frameWidth = contentRect.left - structureRect.left - 1;	*titleBarHeight = contentRect.top - structureRect.top - 1;	DisposeRgn(structureRegionHdl);	DisposeRgn(contentRegionHdl);}// *************************************************************** doSaveWindowSizeAndPositionvoid  doSaveWindowSizeAndPosition(WindowRef windowRef){	docStructureHandle	docStrucHdl;	Rect								portRect;	SInt16							fileRefNum;	OSErr								osError;	windowSizePos				windowSizePosStruct;	windowSizePosHandle	windowSizePosHdl;	docStrucHdl = (docStructureHandle) GetWRefCon(windowRef);	fileRefNum = FSpOpenResFile(&(*docStrucHdl)->fileFSSpec,fsRdWrPerm);	if(fileRefNum < 0)	{		osError = ResError();		doErrorAlert(osError);		return;	}	GetWindowPortBounds(windowRef,&portRect);	SetPortWindowPort(windowRef);	LocalToGlobal(&topLeft(portRect));	LocalToGlobal(&botRight(portRect));	windowSizePosStruct.windowRect = portRect;	windowSizePosHdl = (windowSizePosHandle) Get1Resource(rTypeWinSizePos,kWinSizePosID);	if(windowSizePosHdl != NULL)	{			**windowSizePosHdl = windowSizePosStruct;		ChangedResource((Handle) windowSizePosHdl);		osError = ResError();		if(osError != noErr)			doErrorAlert(osError);	}	else	{		windowSizePosHdl = (windowSizePosHandle) NewHandle(sizeof(windowSizePos));		if(windowSizePosHdl != NULL)		{			**windowSizePosHdl = windowSizePosStruct;			AddResource((Handle) windowSizePosHdl,rTypeWinSizePos,kWinSizePosID,									"\pLast window size and position");		}	}	if(windowSizePosHdl != NULL)	{		UpdateResFile(fileRefNum);		osError = ResError();		if(osError != noErr)			doErrorAlert(osError);		ReleaseResource((Handle) windowSizePosHdl);	}	CloseResFile(fileRefNum);}// *************************************************************************** doGetPageFormatvoid  doGetPageFormat(WindowRef windowRef){	docStructureHandle	docStrucHdl;	SInt16							fileRefNum;	OSErr								osError;	Handle							pageFormatResourceHdl = NULL;	PMPageFormat				pageFormat	= kPMNoPageFormat;	Boolean							settingsChanged;	docStrucHdl = (docStructureHandle) GetWRefCon(windowRef);	HLock((Handle) docStrucHdl);	fileRefNum = FSpOpenResFile(&(*docStrucHdl)->fileFSSpec,fsRdWrPerm);	if(fileRefNum < 0)	{		osError = ResError();		doErrorAlert(osError);		return;	}	pageFormatResourceHdl = Get1Resource(rPageFormat,kPageFormatID);	if(pageFormatResourceHdl != NULL)	{		PMUnflattenPageFormat(pageFormatResourceHdl,&pageFormat);		PMSessionValidatePageFormat(gPrintSession,pageFormat,&settingsChanged);		DisposeHandle((*docStrucHdl)->pageFormatHdl);		PMFlattenPageFormat(pageFormat,&((*docStrucHdl)->pageFormatHdl));		if(pageFormat != kPMNoPageFormat)			PMRelease(&pageFormat);		ReleaseResource(pageFormatResourceHdl);	}	CloseResFile(fileRefNum);	HUnlock((Handle) docStrucHdl);}// ************************************************************************** doSavePageFormatvoid  doSavePageFormat(WindowRef windowRef){	docStructureHandle	docStrucHdl;	Handle							pageFormatHdl;	SInt16							fileRefNum;	OSErr								osError;	Size								handleSize;	docStrucHdl = (docStructureHandle) GetWRefCon(windowRef);	handleSize = GetHandleSize((*docStrucHdl)->pageFormatHdl);	fileRefNum = FSpOpenResFile(&(*docStrucHdl)->fileFSSpec,fsRdWrPerm);	if(fileRefNum < 0)	{		osError = ResError();		doErrorAlert(osError);		return;	}	pageFormatHdl = Get1Resource(rPageFormat,kPageFormatID);	if(pageFormatHdl != NULL)	{		RemoveResource(pageFormatHdl);		DisposeHandle(pageFormatHdl);		pageFormatHdl = NewHandle(handleSize);		BlockMove(*((*docStrucHdl)->pageFormatHdl),*pageFormatHdl,handleSize);		AddResource(pageFormatHdl,rPageFormat,kPageFormatID,"\pPage Format");		osError = ResError();		if(osError != noErr)			doErrorAlert(osError);	}	else	{		pageFormatHdl = NewHandle(handleSize);		if(pageFormatHdl != NULL)		{			BlockMove(*((*docStrucHdl)->pageFormatHdl),*pageFormatHdl,handleSize);			AddResource(pageFormatHdl,rPageFormat,kPageFormatID,"\pPage Format");			osError = ResError();			if(osError != noErr)				doErrorAlert(osError);		}	}	if(pageFormatHdl != NULL)	{		UpdateResFile(fileRefNum);		osError = ResError();		if(osError != noErr)			doErrorAlert(osError);		ReleaseResource(pageFormatHdl);	}	gPageFormatChanged = false;	CloseResFile(fileRefNum);}// *******************************************************************************************