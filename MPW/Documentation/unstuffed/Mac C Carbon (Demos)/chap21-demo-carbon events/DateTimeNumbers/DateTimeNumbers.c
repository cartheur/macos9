// *******************************************************************************************// DateTimeNumbers.c                                                        CARBON EVENT MODEL// *******************************************************************************************//// This program, which opens a single modeless dialog, demonstrates the formatting and display// of dates, times and numbers.//// The program utilises the following resources://// ╔	A 'plst' resource.//// ╔	An 'MBAR' resource, and 'MENU' resources for Apple/Application, File, and Edit menus //		(preload,	non-purgeable).//// ╔	A 'DLOG' resource and associated 'dlgx', 'DITL', 'dfnt', and 'CNTL' resources //		(purgeable).  //// ╔	'hdlg' and 'STR#' resources (purgeable) for balloon help and help tags. //// ╔	A 'SIZE' resource with the acceptSuspendResumeEvents, canBackground, //		doesActivateOnFGSwitch, and isHighLevelEventAware flags set.//// *******************************************************************************************// ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии includes#include <Carbon.h>#include <string.h>// иииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии defines#define rMenubar								128#define mAppleApplication				128#define  iAbout									1#define mFile										129#define  iQuit									12#define mEdit										130#define  iCut										3#define  iCopy									4#define  iPaste									5#define  iClear									6#define rDialog									128#define  iStaticTextTodaysDate	2#define  iStaticTextCurrentTime	4#define  iEditTextTitle					10#define  iEditTextQuantity			11#define  iEditTextValue					12#define  iEditTextDate					13#define  iButtonEnter						18#define  iButtonClear						19#define  iStaticTextTitle				26#define  iStaticTextQuantity		27#define  iStaticTextUnitValue		28#define  iStaticTextTotalValue	29#define  iStaticTextDate				30#define kReturn									0x0D#define kEnter									0x03#define kLeftArrow							0x1C#define kRightArrow							0x1D#define kUpArrow								0x1E#define kDownArrow							0x1F#define kBackspace							0x08#define kDelete									0x7F#define topLeft(r)							(((Point *) &(r))[0])#define botRight(r)							(((Point *) &(r))[1])// ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии global variablesBoolean					gRunningOnX = false;DialogRef				gDialogRef;DateCacheRecord	gDateCacheRec;Boolean					gInBackground;// иииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии function prototypesvoid										main								(void);void										doPreliminaries			(void);OSStatus								appEventHandler			(EventHandlerCallRef,EventRef,void *);OSStatus								windowEventHandler	(EventHandlerCallRef,EventRef,void *);void										doIdle							(void);void										doMenuChoice				(MenuID,MenuItemIndex);void										doCopyPString				(Str255,Str255);void										doTodaysDate				(void);void										doAcceptNewRecord		(void);void										doUnitAndTotalValue	(Str255,Str255);void										doDate							(Str255);void										doAdjustCursor			(WindowRef);void										doClearAllFields		(void);ControlKeyFilterResult	numericFilter				(ControlRef,SInt16 *,SInt16 *,EventModifiers *);void										helpTags						(void);	// ************************************************************************************** mainvoid  main(void){	MenuBarHandle				menubarHdl;	SInt32							response;	MenuRef							menuRef;	ControlKeyFilterUPP	numericFilterUPP;	ControlRef					controlRef;	EventTypeSpec		applicationEvents[] =	{ { kEventClassApplication, kEventAppActivated    },																					{ kEventClassCommand,     kEventProcessCommand  },																					{ kEventClassMouse,       kEventMouseMoved      } };	EventTypeSpec		windowEvents[]			= { { kEventClassWindow,   kEventWindowDrawContent  },																					{ kEventClassWindow,   kEventWindowActivated    },																					{ kEventClassWindow,   kEventWindowClose        },																					{ kEventClassMouse,    kEventMouseDown          },																					{ kEventClassKeyboard, kEventRawKeyDown         } };	// ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии do preliminaries	doPreliminaries();	// иииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии set up menu bar and menus	menubarHdl = GetNewMBar(rMenubar);	if(menubarHdl == NULL)		ExitToShell();	SetMenuBar(menubarHdl);	DrawMenuBar();	Gestalt(gestaltMenuMgrAttr,&response);	if(response & gestaltMenuMgrAquaLayoutMask)	{		menuRef = GetMenuRef(mFile);		if(menuRef != NULL)		{			DeleteMenuItem(menuRef,iQuit);			DeleteMenuItem(menuRef,iQuit - 1);			DisableMenuItem(menuRef,0);		}		gRunningOnX = true;	}	else	{		menuRef = GetMenuRef(mFile);		if(menuRef != NULL)			SetMenuItemCommandID(menuRef,iQuit,kHICommandQuit);	} 	// иииииииииииииииииииииииииииииииииииииииииии install application event handler and a timer  	InstallApplicationEventHandler(NewEventHandlerUPP((EventHandlerProcPtr) appEventHandler),																 GetEventTypeCount(applicationEvents),applicationEvents,																 0,NULL);	InstallEventLoopTimer(GetCurrentEventLoop(),0,TicksToEventTime(GetCaretTime()),												NewEventLoopTimerUPP((EventLoopTimerProcPtr) doIdle),NULL,NULL);	// ииииииииииииииииииииииииииии open modeless dialog, change attributes, and install handler	if(!(gDialogRef = GetNewDialog(rDialog,NULL,(WindowRef) -1)))		ExitToShell();	ChangeWindowAttributes(GetDialogWindow(gDialogRef),kWindowStandardHandlerAttribute |																	 									 kWindowCloseBoxAttribute,																	 									 kWindowCollapseBoxAttribute);	InstallWindowEventHandler(GetDialogWindow(gDialogRef),														NewEventHandlerUPP((EventHandlerProcPtr) windowEventHandler),														GetEventTypeCount(windowEvents),windowEvents,0,NULL);	// ииии create universal procedure pointers for key filter, attach to two edit text controls	numericFilterUPP = NewControlKeyFilterUPP((ControlKeyFilterProcPtr) numericFilter);	GetDialogItemAsControl(gDialogRef,iEditTextQuantity,&controlRef);	SetControlData(controlRef,kControlEntireControl,kControlEditTextKeyFilterTag,								 sizeof(numericFilterUPP),&numericFilterUPP);	GetDialogItemAsControl(gDialogRef,iEditTextValue,&controlRef);	SetControlData(controlRef,kControlEntireControl,kControlEditTextKeyFilterTag,								 sizeof(numericFilterUPP),&numericFilterUPP);	// иииииииииииииииииииииииииииии set help tags, get and display today's date and show window	doTodaysDate();	ShowWindow(GetDialogWindow(gDialogRef));	if(gRunningOnX)		helpTags();	// ииииииииииииииииииииииииииииииии display today's date and initialise date cache structure	InitDateCache(&gDateCacheRec);	// ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии run application event loop	RunApplicationEventLoop();}// *************************************************************************** doPreliminariesvoid  doPreliminaries(void){	MoreMasterPointers(64);	InitCursor();}// *************************************************************************** appEventHandlerOSStatus  appEventHandler(EventHandlerCallRef eventHandlerCallRef,EventRef eventRef,													void * userData){	OSStatus			result = eventNotHandledErr;	UInt32				eventClass;	UInt32				eventKind;	HICommand			hiCommand;	MenuID				menuID;	MenuItemIndex	menuItem;	eventClass = GetEventClass(eventRef);	eventKind  = GetEventKind(eventRef);	switch(eventClass)	{		case kEventClassApplication:			if(eventKind == kEventAppActivated)				SetThemeCursor(kThemeArrowCursor);			break;		case kEventClassCommand:			if(eventKind == kEventProcessCommand)			{				GetEventParameter(eventRef,kEventParamDirectObject,typeHICommand,NULL,													sizeof(HICommand),NULL,&hiCommand);				menuID = GetMenuID(hiCommand.menu.menuRef);				menuItem = hiCommand.menu.menuItemIndex;				if((hiCommand.commandID != kHICommandQuit) && 					 (menuID >= mAppleApplication && menuID <= mEdit))				{					doMenuChoice(menuID,menuItem);					result = noErr;				}			}			break;		case kEventClassMouse:			if(eventKind == kEventMouseMoved)			{				doAdjustCursor(GetDialogWindow(gDialogRef));				result = noErr;			}			break;	}	return result;}// ************************************************************************ windowEventHandlerOSStatus  windowEventHandler(EventHandlerCallRef eventHandlerCallRef,EventRef eventRef,														 void* userData){	OSStatus		result = eventNotHandledErr;	UInt32			eventClass;	UInt32			eventKind;	EventRecord	eventRecord;	SInt16			itemHit;	SInt8				charCode;	ControlRef	controlRef;	UInt32 			finalTicks;	eventClass = GetEventClass(eventRef);	eventKind  = GetEventKind(eventRef);	switch(eventClass)	{		case kEventClassWindow:																							 // event class window			ConvertEventRefToEventRecord(eventRef,&eventRecord);			switch(eventKind)			{				case kEventWindowActivated:					DialogSelect(&eventRecord,&gDialogRef,&itemHit);					result = noErr;					break;				case kEventWindowClose:					QuitApplicationEventLoop();					result = noErr;					break;			}		case kEventClassMouse:																								// event class mouse			ConvertEventRefToEventRecord(eventRef,&eventRecord);			switch(eventKind)			{				case kEventMouseDown:					if(IsDialogEvent(&eventRecord))					{						if(DialogSelect(&eventRecord,&gDialogRef,&itemHit))						{							if(itemHit == iButtonEnter)							{								doAcceptNewRecord();								doClearAllFields();							}							else if(itemHit == iButtonClear)								doClearAllFields();						}					}					doAdjustCursor(GetDialogWindow(gDialogRef));					break;			}			break;		case kEventClassKeyboard:																					 // event class keyboard			switch(eventKind)			{				case kEventRawKeyDown:					ConvertEventRefToEventRecord(eventRef,&eventRecord);					GetEventParameter(eventRef,kEventParamKeyMacCharCodes,typeChar,NULL,														sizeof(charCode),NULL,&charCode);					if((charCode == kReturn) || (charCode == kEnter))					{						GetDialogItemAsControl(gDialogRef,iButtonEnter,&controlRef);						HiliteControl(controlRef,kControlButtonPart);						Delay(8,&finalTicks);						HiliteControl(controlRef,kControlEntireControl);						doAcceptNewRecord();						doClearAllFields();						return noErr;					}					break;			}			break;	}	return result;}// ************************************************************************************ doIdlevoid  doIdle(void){	UInt32				rawSeconds;	static UInt32	oldRawSeconds;	Str255				timeString;	ControlRef		controlRef;	if(!gRunningOnX)		IdleControls(GetDialogWindow(gDialogRef));	GetDateTime(&rawSeconds);	if(rawSeconds > oldRawSeconds) 	{		TimeString(rawSeconds,true,timeString,NULL);		GetDialogItemAsControl(gDialogRef,iStaticTextCurrentTime,&controlRef);		SetControlData(controlRef,kControlEntireControl,kControlStaticTextTextTag,timeString[0],									 &timeString[1]);		Draw1Control(controlRef);		oldRawSeconds = rawSeconds;	}}// ****************************************************************************** doMenuChoicevoid  doMenuChoice(MenuID menuID,MenuItemIndex menuItem){	if(menuID == 0)		return;	switch(menuID)	{		case mAppleApplication:			if(menuItem == iAbout)				SysBeep(10);			break;		case mEdit:			switch(menuItem)			{				case iCut:					DialogCut(gDialogRef);					break;				case iCopy:					DialogCopy(gDialogRef);					break;				case iPaste:					DialogPaste(gDialogRef);					break;				case iClear:					DialogDelete(gDialogRef);					break;			}			break;	}}// ***************************************************************************** doCopyPStringvoid  doCopyPString(Str255 sourceString,Str255 destinationString){	SInt16	stringLength;	stringLength = sourceString[0];	BlockMove(sourceString + 1,destinationString + 1,stringLength);	destinationString[0] = stringLength;}// ****************************************************************************** doTodaysDatevoid  doTodaysDate(void){	UInt32			rawSeconds;	Str255			dateString;	ControlRef	controlRef;	GetDateTime(&rawSeconds);	DateString(rawSeconds,longDate,dateString,NULL);	GetDialogItemAsControl(gDialogRef,iStaticTextTodaysDate,&controlRef);	SetControlData(controlRef,kControlEntireControl,kControlStaticTextTextTag,dateString[0],								 &dateString[1]);}// ************************************************************************* doAcceptNewRecordvoid  doAcceptNewRecord(void){	SInt16			theType;	Handle			theHandle;	Rect				theRect;	Str255			titleString, quantityString, valueString, dateString;	ControlRef	controlRef;	GetDialogItem(gDialogRef,iEditTextTitle,&theType,&theHandle,&theRect);	GetDialogItemText(theHandle,titleString);	GetDialogItem(gDialogRef,iEditTextQuantity,&theType,&theHandle,&theRect);	GetDialogItemText(theHandle,quantityString);	GetDialogItem(gDialogRef,iEditTextValue,&theType,&theHandle,&theRect);	GetDialogItemText(theHandle,valueString);	GetDialogItem(gDialogRef,iEditTextDate,&theType,&theHandle,&theRect);	GetDialogItemText(theHandle,dateString);	if(titleString[0] == 0 || quantityString[0] == 0 || valueString[0] == 0 || 		 dateString[0] == 0)	{		SysBeep(10);		return;	}	GetDialogItemAsControl(gDialogRef,iStaticTextTitle,&controlRef);	SetControlData(controlRef,kControlEntireControl,kControlStaticTextTextTag,titleString[0],								 &titleString[1]);	Draw1Control(controlRef);	GetDialogItemAsControl(gDialogRef,iStaticTextQuantity,&controlRef);	SetControlData(controlRef,kControlEntireControl,kControlStaticTextTextTag,quantityString[0],								 &quantityString[1]);	Draw1Control(controlRef);	doUnitAndTotalValue(valueString,quantityString);	doDate(dateString);}// *********************************************************************** doUnitAndTotalValuevoid  doUnitAndTotalValue(Str255 valueString, Str255 quantityString){	Handle						itl4ResourceHdl;	SInt32						numpartsOffset;	SInt32						numpartsLength;	NumberParts				*numpartsTablePtr;	Str255						formatString = "\p'$'###,###,###.00;'Valueless';'Valueless'";	NumFormatString		formatStringRec;	Str255						formattedNumString;	extended80				value80Bit;	SInt32						quantity;	double						valueDouble;	FormatResultType	result;	ControlRef				controlRef;	GetIntlResourceTable(smSystemScript,iuNumberPartsTable,&itl4ResourceHdl,&numpartsOffset,											 &numpartsLength);	numpartsTablePtr = (NumberPartsPtr) ((SInt32) *itl4ResourceHdl + numpartsOffset);	StringToFormatRec(formatString,numpartsTablePtr,&formatStringRec);	StringToExtended(valueString,&formatStringRec,numpartsTablePtr,&value80Bit);	ExtendedToString(&value80Bit,&formatStringRec,numpartsTablePtr,formattedNumString);	GetDialogItemAsControl(gDialogRef,iStaticTextUnitValue,&controlRef);	SetControlData(controlRef,kControlEntireControl,kControlStaticTextTextTag,								 formattedNumString[0],&formattedNumString[1]);	Draw1Control(controlRef);	StringToNum(quantityString,&quantity);	valueDouble = x80tod(&value80Bit);	valueDouble = valueDouble * quantity;	dtox80(&valueDouble,&value80Bit);	result = ExtendedToString(&value80Bit,&formatStringRec,numpartsTablePtr,														formattedNumString);	if(result == fFormatOverflow)		doCopyPString("\p(Too large to display)",formattedNumString);	GetDialogItemAsControl(gDialogRef,iStaticTextTotalValue,&controlRef);	SetControlData(controlRef,kControlEntireControl,kControlStaticTextTextTag,								 formattedNumString[0],&formattedNumString[1]);	Draw1Control(controlRef);}// ************************************************************************************ doDatevoid  doDate(Str255 dateString){	SInt32				lengthUsed;	LongDateRec		longDateTimeRec;	LongDateTime	longDateTimeValue;	ControlRef		controlRef;	longDateTimeRec.ld.hour = 0;	longDateTimeRec.ld.minute = 0;	longDateTimeRec.ld.second = 0;		StringToDate((Ptr) dateString + 1,dateString[0],&gDateCacheRec,&lengthUsed,							 &longDateTimeRec);	LongDateToSeconds(&longDateTimeRec,&longDateTimeValue);	LongDateString(&longDateTimeValue,longDate,dateString,NULL);	GetDialogItemAsControl(gDialogRef,iStaticTextDate,&controlRef);	SetControlData(controlRef,kControlEntireControl,kControlStaticTextTextTag,dateString[0],								 &dateString[1]);	Draw1Control(controlRef);}// **************************************************************************** doAdjustCursorvoid  doAdjustCursor(WindowRef windowRef){	GrafPtr			oldPort;	RgnHandle		arrowRegion,iBeamRegion;	ControlRef	controlRef;	Rect				iBeamRect;	Point				mouseLocation;	GetPort(&oldPort);	SetPortWindowPort(windowRef);	arrowRegion = NewRgn();	iBeamRegion = NewRgn();	SetRectRgn(arrowRegion,-32768,-32768,32767,32767);		GetKeyboardFocus(windowRef,&controlRef);	GetControlBounds(controlRef,&iBeamRect);	LocalToGlobal(&topLeft(iBeamRect));	LocalToGlobal(&botRight(iBeamRect));		RectRgn(iBeamRegion,&iBeamRect);	DiffRgn(arrowRegion,iBeamRegion,arrowRegion);	GetMouse(&mouseLocation);	LocalToGlobal(&mouseLocation);	if(PtInRgn(mouseLocation,iBeamRegion))		SetThemeCursor(kThemeIBeamCursor);	else		SetThemeCursor(kThemeArrowCursor);	DisposeRgn(arrowRegion);	DisposeRgn(iBeamRegion);	SetPort(oldPort);}// ************************************************************************** doClearAllFieldsvoid  doClearAllFields(void){	SInt16			a;	ControlRef	controlRef;	Str255			theString = "\p";	for(a = iEditTextTitle;a <= iEditTextDate;a++)	{		GetDialogItemAsControl(gDialogRef,a,&controlRef);		SetControlData(controlRef,kControlEntireControl,kControlEditTextTextTag,theString[0],								 &theString[1]);		Draw1Control(controlRef);		if(a == iEditTextTitle)			SetKeyboardFocus(GetDialogWindow(gDialogRef),controlRef,kControlFocusNextPart);	}}// ***************************************************************************** numericFilterControlKeyFilterResult  numericFilter(ControlRef controlRef,SInt16* keyCode,SInt16 *charCode,																			EventModifiers *modifiers){	if(((char) *charCode >= '0') && ((char) *charCode <= '9') || (char) *charCode == '.' ||		 (BitTst(modifiers,15 - cmdKeyBit)))	{		return kControlKeyFilterPassKey;	}	switch(*charCode)	{		case kLeftArrow:		case kRightArrow:		case kUpArrow:		case kDownArrow:		case kBackspace:		case kDelete:			return kControlKeyFilterPassKey;			break;	}	SysBeep(10);	return kControlKeyFilterBlockKey;}// ********************************************************************************** helpTagsvoid  helpTags(void){	HMHelpContentRec	helpContent;	SInt16						a;	static SInt16			itemNumber[7] = { 1,3,21,22,23,24,25 };	ControlRef				controlRef;	HMSetTagDelay(5);	HMSetHelpTagsDisplayed(true);	helpContent.version = kMacHelpVersion;	helpContent.tagSide = kHMOutsideTopCenterAligned;	helpContent.content[kHMMinimumContentIndex].contentType = kHMStringResContent;	helpContent.content[kHMMinimumContentIndex].u.tagStringRes.hmmResID = 128;	for(a = 1;a <= 7; a++)	{		helpContent.content[kHMMinimumContentIndex].u.tagStringRes.hmmIndex = a;		GetDialogItemAsControl(gDialogRef,itemNumber[a - 1],&controlRef);		HMSetControlHelpContent(controlRef,&helpContent);	}}// *******************************************************************************************