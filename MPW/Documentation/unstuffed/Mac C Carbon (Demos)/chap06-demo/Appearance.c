// *******************************************************************************************// Appearance.c                                                            CLASSIC EVENT MODEL// *******************************************************************************************// // This program opens two kWindowDocumentProc windows containing://// ╔	In the first window:////		╔  On Mac OS 8/9, a theme-compliant list view.////		╔  On Mac OS X, some text drawn with Appearance Manager functions.//// ╔	In the second window, various images drawn with Appearance primitives and, on Mac OS //		8/9, text drawn in the window header in the correct Appearance colour.//// Two of the images in the second window are edit text field frames and one is a list box// frame.  At any one time, one of these will have a keyboard focus frame drawn around it.// Clicking in one of the other frames will move the keyboard focus frame to that frame.//// The program utilises the following resources://// ╔	A 'plst' resource.//// ╔	An 'MBAR' resource, and 'MENU' resources for Apple, File, and Edit menus (preload, //		non-purgeable).  //// ╔	Two 'WIND' resources (purgeable) (initially not visible).//// ╔	A 'STR#' list resource (purgeable) containing text drawn in the first window.//// ╔	'hrct' and 'hwin' resources (both purgeable), which provide help balloons describing the//		 contents of the windows (Mac OS 8/9).//// ╔	A 'SIZE' resource with the acceptSuspendResumeEvents,	canBackground, //		doesActivateOnFGSwitch, and isHighLevelEventAware flags set.//// *******************************************************************************************// ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии includes#include <Carbon.h>// иииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии defines#define rMenubar					128#define rNewWindow1				128#define rNewWindow2				129#define mAppleApplication	128#define  iAbout						1#define mFile							129#define  iQuit						12#define sDescription			128#define MAX_UINT32				0xFFFFFFFF// ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии global variablesBoolean		gRunningOnX	= false;Boolean		gDone;Boolean		gInBackground;WindowRef	gWindowRef1, gWindowRef2;SInt16		gPixelDepth;Boolean		gIsColourDevice	= false;Rect			gCurrentRect;Rect			gEditText1Rect	= { 141, 20, 162, 239 };Rect			gEditText2Rect	= { 169, 20, 190, 239 };Rect			gListBoxRect		= { 203, 90, 300, 239 };// иииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии function prototypesvoid	main												(void);void	doPreliminaries							(void);OSErr	quitAppEventHandler					(AppleEvent *,AppleEvent *,SInt32);void	doEvents										(EventRecord *);void	doUpdate										(EventRecord *);void	doActivate									(EventRecord *);void	doActivateWindow						(WindowRef,Boolean);void	doOSEvent										(EventRecord *);void	doDrawAppearancePrimitives	(ThemeDrawState);void	doDrawThemeCompliantTextOn9	(WindowRef,ThemeDrawState);void	doDrawListViewOn9						(WindowRef);void	doDrawThemeTextOnX					(WindowRef,ThemeDrawState);void	doChangeKeyBoardFocus				(Point);void	doGetDepthAndDevice					(void);// ************************************************************************************** mainvoid  main(void){	MenuBarHandle	menubarHdl;	SInt32				response;	MenuRef				menuRef;	SInt16				fontNum;	EventRecord		EventStructure;	// ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии do preliminaries	doPreliminaries();	// иииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии set up menu bar and menus	menubarHdl = GetNewMBar(rMenubar);	if(menubarHdl == NULL)		ExitToShell();	SetMenuBar(menubarHdl);	DrawMenuBar();	Gestalt(gestaltMenuMgrAttr,&response);	if(response & gestaltMenuMgrAquaLayoutMask)	{		menuRef = GetMenuRef(mFile);		if(menuRef != NULL)		{			DeleteMenuItem(menuRef,iQuit);			DeleteMenuItem(menuRef,iQuit - 1);			DisableMenuItem(menuRef,0);		}		gRunningOnX = true;	}	// ииииииииииииииииииииииииииииииииии open first window, set font and font size, show window	if(!(gWindowRef1 = GetNewCWindow(rNewWindow1,NULL,(WindowRef)-1)))		ExitToShell();	SetPortWindowPort(gWindowRef1);	if(!gRunningOnX)		UseThemeFont(kThemeSmallSystemFont,smSystemScript);	else	{		GetFNum("\pAmerican Typewriter",&fontNum);		TextFont(fontNum);		TextSize(11);	}	if(!gRunningOnX)		SetWTitle(gWindowRef1,"\pList Views");	else		SetWTitle(gWindowRef1,"\pTheme Text");	ShowWindow(gWindowRef1);	// ииииииииииииииии open second window, set font, set background colour/pattern, show window	if(!(gWindowRef2 = GetNewCWindow(rNewWindow2,NULL,(WindowRef)-1)))		ExitToShell();	SetPortWindowPort(gWindowRef2);	UseThemeFont(kThemeSmallSystemFont,smSystemScript);	SetThemeWindowBackground(gWindowRef2,kThemeBrushDialogBackgroundActive,false);	ShowWindow(gWindowRef2);	// ииииии get pixel depth and whether colour device for certain Appearance Manager functions	if(!gRunningOnX)		doGetDepthAndDevice();	// ииииииииииии set top edit text field rectangle as target for initial keyboard focus frame	gCurrentRect = gEditText1Rect;	// иииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии enter eventLoop	gDone = false;	while(!gDone)	{		if(WaitNextEvent(everyEvent,&EventStructure,MAX_UINT32,NULL))			doEvents(&EventStructure);	}}// *************************************************************************** doPreliminariesvoid  doPreliminaries(void){	OSErr	osError;	MoreMasterPointers(32);	InitCursor();	FlushEvents(everyEvent,0);	osError = AEInstallEventHandler(kCoreEventClass,kAEQuitApplication,														NewAEEventHandlerUPP((AEEventHandlerProcPtr) quitAppEventHandler),														0L,false);	if(osError != noErr)		ExitToShell();	}// **************************************************************************** doQuitAppEventOSErr  quitAppEventHandler(AppleEvent *appEvent,AppleEvent *reply,SInt32 handlerRefcon){	OSErr			osError;	DescType	returnedType;	Size			actualSize;	osError = AEGetAttributePtr(appEvent,keyMissedKeywordAttr,typeWildCard,&returnedType,NULL,0,															&actualSize);	if(osError == errAEDescNotFound)	{		gDone = true;		osError = noErr;	} 	else if(osError == noErr)		osError = errAEParamMissed;	return osError;}// ********************************************************************************** doEventsvoid  doEvents(EventRecord *eventStrucPtr){	SInt32					menuChoice;	MenuID					menuID;	MenuItemIndex		menuItem;	WindowPartCode	partCode;	WindowRef				windowRef;	switch(eventStrucPtr->what)	{		case kHighLevelEvent:			AEProcessAppleEvent(eventStrucPtr);			break;		case keyDown:			if((eventStrucPtr->modifiers & cmdKey) != 0)			{				menuChoice = MenuEvent(eventStrucPtr);				menuID = HiWord(menuChoice);				menuItem = LoWord(menuChoice);				if(menuID == mFile && menuItem  == iQuit)					gDone = true;			}			break;		case mouseDown:			if(partCode = FindWindow(eventStrucPtr->where,&windowRef))			{				switch(partCode)				{					case inMenuBar:						menuChoice = MenuSelect(eventStrucPtr->where);						menuID = HiWord(menuChoice);						menuItem = LoWord(menuChoice);						if(menuID == 0)							return;						switch(menuID)						{							case mAppleApplication:								if(menuItem == iAbout)								{									SysBeep(10);									HiliteMenu(0);								}								break;							case mFile:								if(menuItem == iQuit)									gDone = true;								break;						}						break;									case inContent:						if(windowRef != FrontWindow())							SelectWindow(windowRef);						else						{							if(FrontWindow() == gWindowRef2)							{								SetPortWindowPort(gWindowRef2);								doChangeKeyBoardFocus(eventStrucPtr->where);							}						}						break;										case inDrag:						DragWindow(windowRef,eventStrucPtr->where,NULL);						break;				}			}			break;		case updateEvt:			doUpdate(eventStrucPtr);			break;		case activateEvt:			doActivate(eventStrucPtr);			break;		case osEvt:			doOSEvent(eventStrucPtr);			break;	}}// ********************************************************************************** doUpdatevoid  doUpdate(EventRecord *eventStrucPtr){	WindowRef	windowRef;	windowRef = (WindowRef) eventStrucPtr->message;	BeginUpdate(windowRef);	SetPortWindowPort(windowRef);	if(windowRef == gWindowRef2)	{		if(gWindowRef2 == FrontWindow() && !gInBackground)		{			doDrawAppearancePrimitives(kThemeStateActive);			DrawThemeFocusRect(&gCurrentRect,true);			if(!gRunningOnX)				doDrawThemeCompliantTextOn9(windowRef,kThemeStateActive);		}		else		{			doDrawAppearancePrimitives(kThemeStateInactive);			if(!gRunningOnX)				doDrawThemeCompliantTextOn9(windowRef,kThemeStateInactive);		}	}	if(windowRef == gWindowRef1)	{		if(!gRunningOnX)			doDrawListViewOn9(windowRef);	}	EndUpdate(windowRef);}// ******************************************************************************** doActivatevoid  doActivate(EventRecord *eventStrucPtr){	WindowRef	windowRef;	Boolean		becomingActive;	windowRef = (WindowRef) eventStrucPtr->message;	becomingActive = ((eventStrucPtr->modifiers & activeFlag) == activeFlag);	doActivateWindow(windowRef,becomingActive);}// ************************************************************************** doActivateWindowvoid  doActivateWindow(WindowRef windowRef,Boolean becomingActive){	if(windowRef == gWindowRef2)	{		SetPortWindowPort(gWindowRef2);		doDrawAppearancePrimitives(becomingActive);		DrawThemeFocusRect(&gCurrentRect,becomingActive);		if(!gRunningOnX)			doDrawThemeCompliantTextOn9(windowRef,becomingActive);	}	else if(windowRef == gWindowRef1 && gRunningOnX)	{		SetPortWindowPort(gWindowRef1);		doDrawThemeTextOnX(windowRef,becomingActive);	}}// ********************************************************************************* doOSEventvoid	doOSEvent(EventRecord *eventStrucPtr){	switch((eventStrucPtr->message >> 24) & 0x000000FF)	{		case suspendResumeMessage:			if((eventStrucPtr->message & resumeFlag) == 1)			{				SetThemeCursor(kThemeArrowCursor);				gInBackground = false;			}			else				gInBackground = true;			break;	}}// **************************************************************** doDrawAppearancePrimitivesvoid  doDrawAppearancePrimitives(ThemeDrawState inState){	Rect	theRect;	if(gRunningOnX)	{		GetWindowPortBounds(gWindowRef2,&theRect);		EraseRect(&theRect);	}	SetRect(&theRect,-1,-1,261,26);	DrawThemeWindowHeader(&theRect,inState);	SetRect(&theRect,20,46,119,115);	DrawThemePrimaryGroup(&theRect,inState);	SetRect(&theRect,140,46,239,115);	DrawThemeSecondaryGroup(&theRect,inState);	SetRect(&theRect,20,127,240,128);	DrawThemeSeparator(&theRect,inState);	DrawThemeEditTextFrame(&gEditText1Rect,inState);	DrawThemeEditTextFrame(&gEditText2Rect,inState);	SetRect(&theRect,20,203,62,245);	DrawThemeGenericWell(&theRect,inState,false);	SetRect(&theRect,20,258,62,300);	DrawThemeGenericWell(&theRect,inState,true);	SetRect(&theRect,75,202,76,302);	DrawThemeSeparator(&theRect,inState);	DrawThemeListBoxFrame(&gListBoxRect,inState);	SetRect(&theRect,-1,321,261,337);	DrawThemePlacard(&theRect,inState);}// *************************************************************** doDrawThemeCompliantTextOn9void  doDrawThemeCompliantTextOn9(WindowRef windowRef,ThemeDrawState inState){	SInt16	windowWidth, stringWidth;	Rect		portRect;	Str255	message = "\pBalloon help is available";	if(inState == kThemeStateActive)		SetThemeTextColor(kThemeTextColorWindowHeaderActive,gPixelDepth,gIsColourDevice);	else		SetThemeTextColor(kThemeTextColorWindowHeaderInactive,gPixelDepth,gIsColourDevice);	GetWindowPortBounds(windowRef,&portRect);	windowWidth = portRect.right - portRect.left;	stringWidth = StringWidth(message);	MoveTo((windowWidth / 2) - (stringWidth / 2), 17);	DrawString(message);	}// ************************************************************************* doDrawListViewOn9void  doDrawListViewOn9(WindowRef windowRef){	Rect		theRect;	SInt16	a;	GetWindowPortBounds(windowRef,&theRect);	SetThemeBackground(kThemeBrushListViewBackground,gPixelDepth,gIsColourDevice);	EraseRect(&theRect);	theRect.left += 130;	SetThemeBackground(kThemeBrushListViewSortColumnBackground,gPixelDepth,gIsColourDevice);	EraseRect(&theRect);	SetThemePen(kThemeBrushListViewSeparator,gPixelDepth,gIsColourDevice);	GetWindowPortBounds(windowRef,&theRect);	for(a=theRect.top;a<=theRect.bottom;a+=18)	{		MoveTo(theRect.left,a);		LineTo(theRect.right - 1,a);	}	SetThemeTextColor(kThemeTextColorListView,gPixelDepth,gIsColourDevice);	for(a=theRect.top;a<=theRect.bottom +18;a+=18)	{		MoveTo(theRect.left,a - 5);		DrawString("\p   List View Background        List View Sort Column");	}}// ************************************************************************ doDrawThemeTextOnXvoid	doDrawThemeTextOnX(WindowRef windowRef,ThemeDrawState inState){	Rect				portRect;	Str255			theString;	CFStringRef	stringRef;	GetWindowPortBounds(windowRef,&portRect);	EraseRect(&portRect);	if(inState == kThemeStateActive)		TextMode(srcOr);	else	  TextMode(grayishTextOr);	SetRect(&portRect,portRect.left,30,portRect.right,50);	DrawThemeTextBox(CFSTR("System Font"),kThemeSystemFont,inState,true,									 &portRect,teJustCenter,NULL);	SetRect(&portRect,portRect.left,60,portRect.right,80);	DrawThemeTextBox(CFSTR("Emphasized System Font"),kThemeEmphasizedSystemFont,inState,true,									 &portRect,teJustCenter,NULL);	SetRect(&portRect,portRect.left,90,portRect.right,105);	DrawThemeTextBox(CFSTR("Small System Font"),kThemeSmallSystemFont,inState,true,									 &portRect,teJustCenter,NULL);	SetRect(&portRect,portRect.left,120,portRect.right,135);	DrawThemeTextBox(CFSTR("Small Emphasized System Font"),kThemeSmallEmphasizedSystemFont,									 inState,true,&portRect,teJustCenter,NULL);	SetRect(&portRect,portRect.left,150,portRect.right,170);	DrawThemeTextBox(CFSTR("Application Font"),kThemeApplicationFont,inState,true,									 &portRect,teJustCenter,NULL);	SetRect(&portRect,portRect.left,180,portRect.right,190);	DrawThemeTextBox(CFSTR("Label Font"),kThemeLabelFont,inState,true,									 &portRect,teJustCenter,NULL);		GetIndString(theString,sDescription,1);	stringRef = CFStringCreateWithPascalString(NULL,theString,CFStringGetSystemEncoding());	SetRect(&portRect,portRect.left + 20,210,portRect.right - 20,300);	DrawThemeTextBox(stringRef,kThemeCurrentPortFont,inState,true,&portRect,teJustCenter,NULL);	if(stringRef != NULL)		CFRelease(stringRef);}// ********************************************************************* doChangeKeyBoardFocusvoid  doChangeKeyBoardFocus(Point mouseXY){	Rect portRect;	DrawThemeFocusRect(&gCurrentRect,false);	DrawThemeEditTextFrame(&gCurrentRect,kThemeStateActive);	SetPortWindowPort(gWindowRef2);	GlobalToLocal(&mouseXY);	if(PtInRect(mouseXY,&gEditText1Rect))		gCurrentRect = gEditText1Rect;	else if(PtInRect(mouseXY,&gEditText2Rect))		gCurrentRect = gEditText2Rect;	else if(PtInRect(mouseXY,&gListBoxRect))		gCurrentRect = gListBoxRect;	GetWindowPortBounds(gWindowRef2,&portRect);	InvalWindowRect(gWindowRef2,&portRect);}// *********************************************************************** doGetDepthAndDevicevoid doGetDepthAndDevice(void){	GDHandle	deviceHdl;	deviceHdl = GetMainDevice();	gPixelDepth = (*(*deviceHdl)->gdPMap)->pixelSize;	if(((1 << gdDevType) & (*deviceHdl)->gdFlags) != 0)		gIsColourDevice = true;}// *******************************************************************************************