// *******************************************************************************************// DialogsAndAlerts.c// *******************************************************************************************// ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии includes#include "DialogsAndAlerts.h"// ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии global variablesBoolean					gRunningOnX					= false;ModalFilterUPP	gEventFilterUPP;Str255					gCurrentString;WindowRef				gWindowRef;SInt32					gSleepTime;Boolean					gDone;Boolean					gGridSnap						= kControlCheckBoxUncheckedValue;Boolean					gShowGrid						= kControlCheckBoxUncheckedValue;Boolean					gShowRule						= kControlCheckBoxUncheckedValue;	SInt16					gBrushType					= iCharcoal;DialogRef				gModelessDialogRef	= NULL;// ************************************************************************************** mainvoid  main(void){	MenuBarHandle	menubarHdl;	SInt32				response;	MenuRef				menuRef;	DialogRef		  dialogRef;	SInt16			  itemHit;	// ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии do preliminaries		doPreliminaries();	// иииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии set up menu bar and menus	menubarHdl = GetNewMBar(rMenubar);	if(menubarHdl == NULL)		ExitToShell();	SetMenuBar(menubarHdl);	DrawMenuBar();	Gestalt(gestaltMenuMgrAttr,&response);	if(response & gestaltMenuMgrAquaLayoutMask)	{		menuRef = GetMenuRef(mFile);		if(menuRef != NULL)		{			DeleteMenuItem(menuRef,iQuit);			DeleteMenuItem(menuRef,iQuit - 1);			DisableMenuItem(menuRef,0);		}				gRunningOnX = true;	}	// иииииииииииииииииии open small modal dialog and automatically dismiss it after 10 seconds	dialogRef = GetNewDialog(rSplash,NULL,(WindowRef) -1);	SetDialogTimeout(dialogRef,kStdOkItemIndex,10);	do	{		ModalDialog(NULL,&itemHit);		} while(itemHit != kStdOkItemIndex);		DisposeDialog(dialogRef);	// ииииииииииииииииииииииииииии create universal procedure pointer for event filter function	gEventFilterUPP = NewModalFilterUPP((ModalFilterProcPtr) eventFilter);	// иииииииииииииииииииииииииииииииииииииииииииииииии initial advisory text for window header	doCopyPString("\pBalloon (OS 8/9) and Help tag (OS X) help is available",gCurrentString);	// ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии open a window, set font size	if(!(gWindowRef = GetNewCWindow(rWindow,NULL,(WindowRef)-1)))		ExitToShell();	SetPortWindowPort(gWindowRef);	if(!gRunningOnX)		TextSize(10);	// иииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии enter eventLoop	eventLoop();}// *************************************************************************** doPreliminariesvoid  doPreliminaries(void){	OSErr	osError;		MoreMasterPointers(192);	InitCursor();	FlushEvents(everyEvent,0);	osError = AEInstallEventHandler(kCoreEventClass,kAEQuitApplication,														NewAEEventHandlerUPP((AEEventHandlerProcPtr) quitAppEventHandler),														0L,false);	if(osError != noErr)		ExitToShell();}// **************************************************************************** doQuitAppEventOSErr  quitAppEventHandler(AppleEvent *appEvent,AppleEvent *reply,SInt32 handlerRefcon){	OSErr			osError;	DescType	returnedType;	Size			actualSize;	osError = AEGetAttributePtr(appEvent,keyMissedKeywordAttr,typeWildCard,&returnedType,NULL,0,															&actualSize);	if(osError == errAEDescNotFound)	{		gDone = true;		osError = noErr;	} 	else if(osError == noErr)		osError = errAEParamMissed;	return osError;}// ********************************************************************************* eventLoopvoid  eventLoop(void){	EventRecord	eventStructure;	Boolean			gotEvent;	gSleepTime = MAX_UINT32;	gDone = false;	while(!gDone)	{		gotEvent = WaitNextEvent(everyEvent,&eventStructure,gSleepTime,NULL);		if(gotEvent)			doEvents(&eventStructure);		else		{			if(eventStructure.what == nullEvent)				if(!gRunningOnX)					doIdle();		}	}}// ************************************************************************************ doIdlevoid  doIdle(void){	if(FrontWindow() == GetDialogWindow(gModelessDialogRef))		IdleControls(GetDialogWindow(gModelessDialogRef));}// ********************************************************************************** doEventsvoid	doEvents(EventRecord *eventStrucPtr){	switch(eventStrucPtr->what)	{		case kHighLevelEvent:			AEProcessAppleEvent(eventStrucPtr);			break;					case mouseDown:			doMouseDown(eventStrucPtr);			break;		case keyDown:			doKeyDown(eventStrucPtr);			break;		case autoKey:			if((eventStrucPtr->modifiers & cmdKey) == 0)				doKeyDown(eventStrucPtr);			break;		case updateEvt:			doUpdate(eventStrucPtr);			break;		case activateEvt:			doActivate(eventStrucPtr);			break;		case osEvt:			doOSEvent(eventStrucPtr);			break;	}}// ******************************************************************************* doMouseDownvoid	doMouseDown(EventRecord *eventStrucPtr){	WindowRef				windowRef;	WindowPartCode	partCode;	partCode = FindWindow(eventStrucPtr->where,&windowRef);	switch(partCode)	{		case inMenuBar:			doAdjustMenus();			doMenuChoice(MenuSelect(eventStrucPtr->where));			break;		case inContent:			if(windowRef != FrontWindow())				SelectWindow(windowRef);			else				doInContent(eventStrucPtr);			break;		case inDrag:			DragWindow(windowRef,eventStrucPtr->where,NULL);			break;		case inGoAway:			if(TrackGoAway(windowRef,eventStrucPtr->where))			{				if(GetWindowKind(windowRef) == kDialogWindowKind)				{					doHideModelessDialog(windowRef);					doCopyPString("\pBalloon (OS 8/9) and Help tag (OS X) help is available",												gCurrentString);				}			}			break;	}}// ********************************************************************************* doKeyDownvoid  doKeyDown(EventRecord *eventStrucPtr){	WindowRef		windowRef;	SInt8				charCode;	SInt32			windowRefCon;	SInt16 			itemHit;	ControlRef	controlRef;	UInt32			finalTicks;	DialogRef		dialogRef;		windowRef = FrontWindow();	charCode = eventStrucPtr->message & charCodeMask;	if(!(IsDialogEvent(eventStrucPtr)))	{		if((eventStrucPtr->modifiers & cmdKey) != 0)		{			doAdjustMenus();			doMenuChoice(MenuEvent(eventStrucPtr));		}	}	else	{		windowRefCon = GetWRefCon(windowRef);		if(windowRefCon == kSearchModeless || windowRefCon == kSheetDialog)		{			if((charCode == kReturn) || (charCode == kEnter))			{				GetDialogItemAsControl(GetDialogFromWindow(windowRef),kStdOkItemIndex,&controlRef);				HiliteControl(controlRef,kControlButtonPart);				Delay(8,&finalTicks);				HiliteControl(controlRef,kControlEntireControl);				if(windowRefCon == kSearchModeless)					doButtonHitInSearchModeless();				else if(windowRefCon == kSheetDialog)					doButtonHitInSheetDialog();				return;			}			if((eventStrucPtr->modifiers & cmdKey) != 0)			{				if(charCode == 'X' || charCode == 'x' ||	charCode == 'C' || charCode == 'c' ||						charCode == 'V' || charCode == 'v')				{					HiliteMenu(mEdit);					DialogSelect(eventStrucPtr,&dialogRef,&itemHit);					Delay(4,&finalTicks);					HiliteMenu(0);				}				else				{					doAdjustMenus();					doMenuChoice(MenuEvent(eventStrucPtr));				}				return;			}			DialogSelect(eventStrucPtr,&dialogRef,&itemHit);		}	}}// ********************************************************************************** doUpdatevoid  doUpdate(EventRecord *eventStrucPtr){	WindowRef	windowRef;	DialogRef	dialogRef;	SInt16		itemHit;	if(!(IsDialogEvent(eventStrucPtr)))	{		windowRef = (WindowRef) eventStrucPtr->message;		doUpdateDocument(windowRef);	}	else		DialogSelect(eventStrucPtr,&dialogRef,&itemHit);}// ************************************************************************** doUpdateDocumentvoid  doUpdateDocument(WindowRef windowRef){	GrafPtr				oldPort;	PixPatHandle	pixpatHdl;	Rect					portRect;	BeginUpdate(windowRef);	GetPort(&oldPort);	SetPortWindowPort(windowRef);	pixpatHdl = GetPixPat(rPixelPattern);	GetWindowPortBounds(windowRef,&portRect);	FillCRect(&portRect,pixpatHdl);	DisposePixPat(pixpatHdl);	doDrawMessage(windowRef,windowRef == FrontWindow());	SetPort(oldPort);	EndUpdate(windowRef);}// ******************************************************************************** doActivatevoid  doActivate(EventRecord *eventStrucPtr){	Boolean		becomingActive;	WindowRef	windowRef;	becomingActive = (eventStrucPtr->modifiers & activeFlag) == activeFlag;	if(!(IsDialogEvent(eventStrucPtr)))	{		windowRef = (WindowRef) eventStrucPtr->message;		doActivateDocument(windowRef,becomingActive);	}	else		doActivateDialogs(eventStrucPtr,becomingActive);}// ************************************************************************ doActivateDocumentvoid  doActivateDocument(WindowRef windowRef,Boolean becomingActive){	if(becomingActive)		doAdjustMenus();	doDrawMessage(windowRef,becomingActive);}// ****************************************************************** doActivateModelessDialogvoid  doActivateDialogs(EventRecord *eventStrucPtr,Boolean becomingActive){	DialogRef	dialogRef;	SInt16		windowRefCon;	SInt16 		itemHit;		DialogSelect(eventStrucPtr,&dialogRef,&itemHit);	windowRefCon = GetWRefCon(GetDialogWindow(dialogRef));	if(becomingActive)	{		doAdjustMenus();		if(windowRefCon == kSearchModeless || windowRefCon == kSheetDialog)			gSleepTime = GetCaretTime();	}	else	{		if(windowRefCon == kSearchModeless || windowRefCon == kSheetDialog)			gSleepTime = MAX_UINT32;	}}// ********************************************************************************* doOSEventvoid	doOSEvent(EventRecord *eventStrucPtr){	switch((eventStrucPtr->message >> 24) & 0x000000FF)	{		case suspendResumeMessage:			if((eventStrucPtr->message & resumeFlag) == 1)				SetThemeCursor(kThemeArrowCursor);			break;	}}// ***************************************************************************** doAdjustMenusvoid  doAdjustMenus(void){	WindowRef	windowRef;	MenuRef		menuRef;	SInt32		windowRefCon;	windowRef = FrontWindow();	if(GetWindowKind(windowRef) == kApplicationWindowKind)	{		menuRef = GetMenuRef(mFile);		DisableMenuItem(menuRef,iClose);		menuRef = GetMenuRef(mEdit);		DisableMenuItem(menuRef,0);		menuRef = GetMenuRef(mDemonstration);		EnableMenuItem(menuRef,iModeless);		if(gRunningOnX)		{			if(IsWindowCollapsed(gWindowRef))			{				DisableMenuItem(menuRef,iWindowModalDialog);				DisableMenuItem(menuRef,iWindowModalAlert);			}			else			{				EnableMenuItem(menuRef,iWindowModalDialog);				EnableMenuItem(menuRef,iWindowModalAlert);			}		}	}	else if(GetWindowKind(windowRef) == kDialogWindowKind)	{		windowRefCon = GetWRefCon(windowRef);		if(windowRefCon == kSearchModeless)		{			menuRef = GetMenuRef(mFile);			EnableMenuItem(menuRef,iClose);			menuRef = GetMenuRef(mEdit);			EnableMenuItem(menuRef,0);					menuRef = GetMenuRef(mDemonstration);			DisableMenuItem(menuRef,iModeless);		}		else if(windowRefCon == kSheetDialog)		{			menuRef = GetMenuRef(mFile);			DisableMenuItem(menuRef,iClose);			menuRef = GetMenuRef(mEdit);			EnableMenuItem(menuRef,0);					menuRef = GetMenuRef(mDemonstration);			EnableMenuItem(menuRef,iModeless);			DisableMenuItem(menuRef,iWindowModalAlert);		}		else		{			menuRef = GetMenuRef(mFile);			DisableMenuItem(menuRef,iClose);			menuRef = GetMenuRef(mEdit);			DisableMenuItem(menuRef,0);					menuRef = GetMenuRef(mDemonstration);			EnableMenuItem(menuRef,iModeless);		}	}	DrawMenuBar();}// ****************************************************************************** doMenuChoicevoid  doMenuChoice(SInt32 menuChoice){	MenuID				menuID;	MenuItemIndex	menuItem;	SInt16				windowRefCon;	menuID = HiWord(menuChoice);	menuItem = LoWord(menuChoice);	if(menuID == 0)		return;	switch(menuID)	{		case mAppleApplication:			if(menuItem == iAbout)				SysBeep(10);			break;		case mFile:			if(menuItem == iQuit)				gDone = true;			else if(menuItem == iClose)			{				if(GetWindowKind(FrontWindow()) == kDialogWindowKind)				{					windowRefCon = GetWRefCon(FrontWindow());					if(windowRefCon == kSearchModeless)						doHideModelessDialog(GetDialogWindow(gModelessDialogRef));				}			}			break;		case mEdit:			doEditMenu(menuItem);			break;		case mDemonstration:			doDemonstrationMenu(menuItem);			break;	}	HiliteMenu(0);}// ******************************************************************************** doEditMenuvoid	doEditMenu(MenuItemIndex menuItem){	WindowRef	windowRef;	SInt16		windowRefCon;	DialogRef	dialogRef;	windowRef = FrontWindow();	if(GetWindowKind(FrontWindow()) == kDialogWindowKind)	{		windowRefCon = GetWRefCon(windowRef);		if(windowRefCon == kSearchModeless || windowRefCon == kSheetDialog)		{			dialogRef = GetDialogFromWindow(windowRef);			switch(menuItem)			{				case iCut:					DialogCut(dialogRef);					break;				case iCopy:					DialogCopy(dialogRef);					break;				case iPaste:					DialogPaste(dialogRef);					break;				case iClear:					DialogDelete(dialogRef);					break;			}		}	}}// *********************************************************************** doDemonstrationMenuvoid	doDemonstrationMenu(MenuItemIndex menuItem){	switch(menuItem)	{		case iModalAlert:			if(!doModalAlerts(false))			{				SysBeep(10);				ExitToShell();			}			break;		case iMovableAlert:			if(gRunningOnX)			{				if(!doMovableModalAlertOnX())				{					SysBeep(10);					ExitToShell();				}			}			else if(!doModalAlerts(true))			{				SysBeep(10);				ExitToShell();			}			break;		case iModalDialog:			if(!doModalDialog())			{				SysBeep(10);				ExitToShell();			}			break;		case iMovableModalDialog:			if(!doMovableModalDialog())			{				SysBeep(10);				ExitToShell();			}			break;		case iModeless:			if(!doCreateOrShowModelessDialog())			{				SysBeep(10);				ExitToShell();			}			break;		case iWindowModalAlert:			if(!doSheetAlert())			{				SysBeep(10);				ExitToShell();			}			break;		case iWindowModalDialog:			if(!doSheetDialog())			{				SysBeep(10);				ExitToShell();			}			break;	}}// ************************************************************ doExplicitlyDeactivateDocumentvoid  doExplicitlyDeactivateDocument(void){	if(FrontWindow() && (GetWindowKind(FrontWindow()) != kDialogWindowKind))		doActivateDocument(FrontWindow(),false);}// ***************************************************************************** doModalAlertsBoolean  doModalAlerts(Boolean movable){	AlertStdAlertParamRec	paramRec;	Str255								messageText, informativeText;	Str255								otherText = "\pOther";	OSErr									osError;	DialogItemIndex				itemHit;	doExplicitlyDeactivateDocument();	paramRec.movable				= movable;	paramRec.helpButton			= true;	paramRec.filterProc			= gEventFilterUPP;	paramRec.defaultText		= (StringPtr) kAlertDefaultOKText;	paramRec.cancelText			= (StringPtr) kAlertDefaultCancelText;	paramRec.otherText			= (StringPtr) &otherText;	paramRec.defaultButton	= kAlertStdAlertOKButton;	paramRec.cancelButton		= kAlertStdAlertCancelButton;	paramRec.position				= kWindowDefaultPosition;	if(!movable)		GetIndString(messageText,rAlertStrings,sModalMessage);	else		GetIndString(messageText,rAlertStrings,sMovableMessage);	GetIndString(informativeText,rAlertStrings,sModalInformative);	osError = StandardAlert(kAlertStopAlert,messageText,informativeText,&paramRec,&itemHit);	if(osError == noErr)	{		if(itemHit == kAlertStdAlertOKButton)			doCopyPString("\pOK Button hit",gCurrentString);		else if (itemHit == kAlertStdAlertCancelButton)			doCopyPString("\pCancel Button hit",gCurrentString);		else if (itemHit == kAlertStdAlertOtherButton)			doCopyPString("\pOther Button hit",gCurrentString);		else if (itemHit == kAlertStdAlertHelpButton)			doCopyPString("\pHelp Button hit",gCurrentString);	}	return (osError == noErr);}// ******************************************************************** doMovableModalAlertOnXBoolean  doMovableModalAlertOnX(void){	AlertStdCFStringAlertParamRec	paramRec;	Str255												messageText, informativeText;	CFStringRef										messageTextCF, informativeTextCF;	OSErr													osError;	DialogRef											dialogRef;	DialogItemIndex								itemHit;	doExplicitlyDeactivateDocument();	GetStandardAlertDefaultParams(&paramRec,kStdCFStringAlertVersionOne);	paramRec.movable			= true;	paramRec.helpButton		= true;	paramRec.cancelButton	= kAlertStdAlertCancelButton;	paramRec.cancelText		= CFSTR("Cancel");	paramRec.otherText		= CFSTR("Other");	GetIndString(messageText,rAlertStrings,sMovableMessage);	GetIndString(informativeText,rAlertStrings,sMovableInformative);	messageTextCF = CFStringCreateWithPascalString(NULL,messageText,																								 CFStringGetSystemEncoding());	informativeTextCF = CFStringCreateWithPascalString(NULL,informativeText,																										 CFStringGetSystemEncoding());	osError = CreateStandardAlert(kAlertCautionAlert,messageTextCF,informativeTextCF,&paramRec,																&dialogRef);	if(osError == noErr)	{		osError = RunStandardAlert(dialogRef,NULL,&itemHit);		if(osError == noErr)		{			if(itemHit == kAlertStdAlertOKButton)				doCopyPString("\pOK Button hit",gCurrentString);			else if (itemHit == kAlertStdAlertCancelButton)				doCopyPString("\pCancel Button hit",gCurrentString);			else if (itemHit == kAlertStdAlertOtherButton)				doCopyPString("\pOther Button hit",gCurrentString);			else if (itemHit == kAlertStdAlertHelpButton)				doCopyPString("\pHelp Button hit",gCurrentString);		}	}	if(messageTextCF != NULL)		CFRelease(messageTextCF);	if(informativeTextCF != NULL)		CFRelease(informativeTextCF);	return (osError == noErr);}// ***************************************************************************** doModalDialogBoolean  doModalDialog(void){	DialogRef		dialogRef;	ControlRef	controlRef;	OSStatus		osError;	MenuRef			menuRef;	SInt16			numberOfItems, itemHit, controlValue;	doExplicitlyDeactivateDocument();	if(!(dialogRef = GetNewDialog(rModalDialog,NULL,(WindowRef) -1)))		return false; 	SetDialogDefaultItem(dialogRef,kStdOkItemIndex);	SetDialogCancelItem(dialogRef,kStdCancelItemIndex);	GetDialogItemAsControl(dialogRef,iGridSnap,&controlRef);	SetControlValue(controlRef,gGridSnap);	GetDialogItemAsControl(dialogRef,iShowGrid,&controlRef);	SetControlValue(controlRef,gShowGrid);	GetDialogItemAsControl(dialogRef,iShowRulers,&controlRef);	SetControlValue(controlRef,gShowRule);	menuRef = NewMenu(mFont,NULL);	if((osError = CreateStandardFontMenu(menuRef,0,0,0,NULL)) == noErr)	{		GetDialogItemAsControl(dialogRef,iFont,&controlRef);		SetControlMinimum(controlRef,1);		numberOfItems = CountMenuItems(menuRef);		SetControlMaximum(controlRef,numberOfItems);		SetControlData(controlRef,kControlEntireControl,kControlPopupButtonMenuRefTag,									 sizeof(menuRef),&menuRef);	}	else		return false;//	if(gRunningOnX)		helpTagsModal(dialogRef);	ShowWindow(GetDialogWindow(dialogRef));	do	{		ModalDialog(gEventFilterUPP,&itemHit);				if(itemHit == iGridSnap || itemHit == iShowGrid || itemHit == iShowRulers)		{			GetDialogItemAsControl(dialogRef,itemHit,&controlRef);			SetControlValue(controlRef,!GetControlValue(controlRef));		}		else if(itemHit == iFont || itemHit == iSound)		{			GetDialogItemAsControl(dialogRef,itemHit,&controlRef);			controlValue = GetControlValue(controlRef);			doPopupMenuChoice(controlRef,controlValue);		}	} while((itemHit != kStdOkItemIndex) && (itemHit != kStdCancelItemIndex));	if(itemHit == kStdOkItemIndex)	{		GetDialogItemAsControl(dialogRef,iGridSnap,&controlRef);		gGridSnap = GetControlValue(controlRef);		GetDialogItemAsControl(dialogRef,iShowGrid,&controlRef);		gShowGrid = GetControlValue(controlRef);		GetDialogItemAsControl(dialogRef,iShowRulers,&controlRef);		gShowRule = GetControlValue(controlRef);					}	DisposeDialog(dialogRef);	doCopyPString("\pBalloon (OS 8/9) and Help tag (OS X) help is available",gCurrentString);	return true;}// ********************************************************************** doMovableModalDialogBoolean  doMovableModalDialog(void){	DialogRef		dialogRef;	ControlRef	controlRef;	SInt16			oldBrushType, itemHit, a;	doExplicitlyDeactivateDocument();	if(!(dialogRef = GetNewDialog(rMovableModalDialog,NULL,(WindowRef) -1)))		return false;	SetDialogDefaultItem(dialogRef,kStdOkItemIndex);	SetDialogCancelItem(dialogRef,kStdCancelItemIndex);	SetDialogTracksCursor(dialogRef,true);	GetDialogItemAsControl(dialogRef,gBrushType,&controlRef);	SetControlValue(controlRef,kControlRadioButtonCheckedValue);		GetDialogItemAsControl(dialogRef,iClockOne,&controlRef);	SetKeyboardFocus(GetDialogWindow(dialogRef),controlRef,kControlClockPart);	oldBrushType = gBrushType;	if(gRunningOnX)		helpTagsMovableModal(dialogRef);	ShowWindow(GetDialogWindow(dialogRef));	do	{		ModalDialog(gEventFilterUPP,&itemHit);		if(itemHit >= iCharcoal && itemHit <= iChalk)		{			for(a=iCharcoal;a<=iChalk;a++)			{				GetDialogItemAsControl(dialogRef,a,&controlRef);				SetControlValue(controlRef,kControlRadioButtonUncheckedValue);			}			GetDialogItemAsControl(dialogRef,itemHit,&controlRef);			SetControlValue(controlRef,kControlRadioButtonCheckedValue);			gBrushType = itemHit;		}	} while((itemHit != kStdOkItemIndex) && (itemHit != kStdCancelItemIndex));	if(itemHit == kStdCancelItemIndex)		gBrushType = oldBrushType;	DisposeDialog(dialogRef);	return true;}// ************************************************************** doCreateOrShowModelessDialogBoolean  doCreateOrShowModelessDialog(void){	ControlRef	controlRef;	Str255			stringData = "\pwicked googly";	MenuRef			menuRef;	if(gModelessDialogRef == NULL)	{		if(!(gModelessDialogRef = GetNewDialog(rModelessDialog,NULL,(WindowRef) -1)))			return false;		SetWRefCon(GetDialogWindow(gModelessDialogRef),(SInt32) kSearchModeless);				SetDialogDefaultItem(gModelessDialogRef,kStdOkItemIndex);		GetDialogItemAsControl(gModelessDialogRef,iEditTextSearchModeless,&controlRef);		SetDialogItemText((Handle) controlRef,stringData);		SelectDialogItemText(gModelessDialogRef,iEditTextSearchModeless,0,32767);		if(gRunningOnX)			helpTagsModeless(gModelessDialogRef);		ShowWindow(GetDialogWindow(gModelessDialogRef));	}	else	{		ShowWindow(GetDialogWindow(gModelessDialogRef));		SelectWindow(GetDialogWindow(gModelessDialogRef));	}	if(gRunningOnX)	{		menuRef = GetMenuRef(mFile);		EnableMenuItem(menuRef,0);	}	return true;}// ******************************************************************************* doInContentvoid  doInContent(EventRecord *eventStrucPtr){	WindowRef	windowRef;	SInt32		windowRefCon;	DialogRef	dialogRef;	SInt16		itemHit;	windowRef = FrontWindow();	if(!(IsDialogEvent(eventStrucPtr)))	{		// Handle clicks in document window content region here.	}	else	{		windowRefCon = GetWRefCon(windowRef);		if(windowRefCon == kSearchModeless)		{			if(DialogSelect(eventStrucPtr,&dialogRef,&itemHit))				if(itemHit == kStdOkItemIndex)					doButtonHitInSearchModeless();		}		else if(windowRefCon == kSheetDialog)		{			if(DialogSelect(eventStrucPtr,&dialogRef,&itemHit))				if(itemHit == kStdOkItemIndex)					doButtonHitInSheetDialog();		}	}}// *************************************************************** doButtonHitInSearchModelessvoid  doButtonHitInSearchModeless(void){	ControlRef	controlRef;	GrafPtr			oldPort;	GetDialogItemAsControl(gModelessDialogRef,iEditTextSearchModeless,&controlRef);	GetDialogItemText((Handle) controlRef,gCurrentString);	GetPort(&oldPort);	SetPortWindowPort(gWindowRef);	doDrawMessage(gWindowRef,false);	SetPort(oldPort);}// ********************************************************************** doHideModelessDialogvoid  doHideModelessDialog(WindowRef windowRef){	SInt16	windowRefCon;	MenuRef	menuRef;	if(gRunningOnX)		BringToFront(gWindowRef);	HideWindow(windowRef);	windowRefCon = GetWRefCon(windowRef);	if(windowRefCon == kSearchModeless)		gSleepTime = MAX_UINT32;	if(gRunningOnX)	{		menuRef = GetMenuRef(mFile);		DisableMenuItem(menuRef,0);	}}// ******************************************************************************* eventFilterBoolean  eventFilter(DialogRef dialogRef,EventRecord *eventStrucPtr,SInt16 *itemHit){	Boolean	handledEvent;	GrafPtr	oldPort;	handledEvent = false;		if((eventStrucPtr->what == updateEvt) && 		 ((WindowRef) eventStrucPtr->message != GetDialogWindow(dialogRef)))	{		if(!gRunningOnX)			doUpdate(eventStrucPtr);	}	else if((eventStrucPtr->what == autoKey) && ((eventStrucPtr->modifiers & cmdKey) != 0))	{		handledEvent = true;		return handledEvent;	}	else	{		GetPort(&oldPort);		SetPortDialogPort(dialogRef);		handledEvent = StdFilterProc(dialogRef,eventStrucPtr,itemHit);		SetPort(oldPort);	}	return handledEvent;}// ************************************************************************* doPopupMenuChoicevoid  doPopupMenuChoice(ControlRef controlRef,SInt16 controlValue){	MenuRef	menuRef;	Size		actualSize;	Str255	itemName;	GrafPtr	oldPort;	GetControlData(controlRef,kControlEntireControl,kControlPopupButtonMenuHandleTag,								 sizeof(menuRef),&menuRef,&actualSize);	GetMenuItemText(menuRef,controlValue,itemName);			doCopyPString(itemName,gCurrentString);	GetPort(&oldPort);	SetPortWindowPort(gWindowRef);	doDrawMessage(gWindowRef,false);	SetPort(oldPort);}// ***************************************************************************** doDrawMessagevoid  doDrawMessage(WindowRef windowRef,Boolean inState){	Rect				portRect, headerRect;	CFStringRef	stringRef;	Rect				textBoxRect;	if(windowRef == gWindowRef)	{		SetPortWindowPort(windowRef);		GetWindowPortBounds(windowRef,&portRect);		SetRect(&headerRect,portRect.left - 1,portRect.bottom - 26,portRect.right + 1,						portRect.bottom + 1);		DrawThemePlacard(&headerRect,inState);		if(inState == kThemeStateActive)			TextMode(srcOr);		else			TextMode(grayishTextOr);		stringRef = CFStringCreateWithPascalString(NULL,gCurrentString,																							 CFStringGetSystemEncoding());		SetRect(&textBoxRect,portRect.left,portRect.bottom - 19,portRect.right,							portRect.bottom - 4);		DrawThemeTextBox(stringRef,kThemeSmallSystemFont,0,true,&textBoxRect,teJustCenter,NULL);		if(stringRef != NULL)					CFRelease(stringRef);		TextMode(srcOr);	}}// ***************************************************************************** doCopyPStringvoid  doCopyPString(Str255 sourceString,Str255 destinationString){	SInt16	stringLength;	stringLength = sourceString[0];	BlockMove(sourceString + 1,destinationString + 1,stringLength);	destinationString[0] = stringLength;}// *******************************************************************************************